<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0012">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ğŸš¨ RESCUE</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getDatabase, ref, set, get, onValue, push, update, remove, query, orderByChild, limitToLast, onChildAdded } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js';
import { getFirestore, doc, setDoc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG â€” Ù…ÙØ¯Ù…Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (ØºÙŠØ± Ù…Ø±Ø¦ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” SECURITY LAYER â€” Firebase config encrypted (XOR + B64 x3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _ENC = '==QPjZkQvhnUGZVQzUURzFUQFN3VRJVRYZGW0pnQHNmVQZTQtVkTvJkV69WMXBFdFZmSZdXV3F0aHhFZxUFdZhnU08GRRR1YoJkQwR1TkFkQFdUQWlUTwZ0QjdHWVJEawkUVaNjVY5kVMd1YF9UO5IUVRFEaSd3dpZFSFV1USlFRZNGbwEFMvtmVUp0VEdFOxglUG5mRhVzQMNlQCVkUvZlT4ZkVFhVRnhUbVVFWMJEMPJEbnJleRFjVCZlRRdnWWNEN4knUHBjURpURzUEaClmQBlkRNlEexM1Q4h1QHRDMMNEcoFVQOx2TLlkVLZTRwcEVwsmVn92QVdUWRFkUnJzQH5EMSp3bFlFTSRkVWJkQIFVQEt0Y4RUQmhmUH50dsZGd54mQYN3UWx2cxQlaOV0SIRmUa10Ytl1SGxmUjFUQZFXVpVmejZ1VS9WaPRDe4V0UFJ1S';
const _XK  = 'R3scu3_S3cur3_K3y_2024!@#$%^&*()';
function _dec(e,k){
  try{
    const r=e.split('').reverse().join('');
    const b=atob(atob(r));
    let s='';
    for(let i=0;i<b.length;i++) s+=String.fromCharCode(b.charCodeAt(i)^k.charCodeAt(i%k.length));
    return JSON.parse(s);
  }catch{return null;}
}
const _HARDCODED_CFG = _dec(_ENC, _XK);
function _loadConfig(){ return _HARDCODED_CFG; }
function _saveConfig(cfg){}
function _clearConfig(){}

let _savedCfg = _HARDCODED_CFG;


// â”€â”€ SHA-256 Ù„ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sha256(msg) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
// â”€â”€ Rate Limiter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _RL = { attempts: {}, max: 5, window: 300000 };
function _checkRL(key) {
  const now = Date.now();
  if (!_RL.attempts[key]) _RL.attempts[key] = [];
  _RL.attempts[key] = _RL.attempts[key].filter(t => now - t < _RL.window);
  if (_RL.attempts[key].length >= _RL.max) {
    const wait = Math.ceil((_RL.window - (now - _RL.attempts[key][0])) / 60000);
    throw new Error(`ğŸ”’ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©. Ø§Ù†ØªØ¸Ø± ${wait} Ø¯Ù‚ÙŠÙ‚Ø©`);
  }
  _RL.attempts[key].push(now);
}
function _clearRL(key) { delete _RL.attempts[key]; }
// â”€â”€ Input Sanitizer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _sanitize(str) {
  if (typeof str !== 'string') return '';
  return str.replace(/[<>"'\x00-\x1f]/g, '').trim().slice(0, 100);
}
// â”€â”€ Anti-DevTools (ÙŠØµØ¹Ù‘Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function _antiDebug(){
  let _dt = false;
  const _chk = () => {
    const t0 = performance.now();
    debugger;
    if (performance.now() - t0 > 80) { _dt = true; }
  };
  setInterval(_chk, 1500);
  // Ù…Ù†Ø¹ console
  const _noop = ()=>{};
  try {
    Object.defineProperty(window, 'console', {
      get(){ return { log:_noop, warn:_noop, error:_noop, info:_noop, debug:_noop, table:_noop, dir:_noop }; },
      configurable: false
    });
  } catch {}
})();
// â”€â”€ Context Menu + DevTools shortcut blocker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key)) ||
      (e.ctrlKey && e.key === 'U')) {
    e.preventDefault(); e.stopPropagation(); return false;
  }
});

let _db, _fs, _app;
let DEMO = false;
const _bc = new BroadcastChannel('_rsc_ch');
const _DK  = '_rsc_db';

function _isRealConfig(cfg){
  return cfg && cfg.apiKey && !cfg.apiKey.includes('DEMO') &&
         !cfg.apiKey.includes('REPLACE') && cfg.apiKey.length > 20 &&
         cfg.databaseURL && cfg.databaseURL.includes('firebaseio');
}

function _initFirebase(cfg){
  if(!_isRealConfig(cfg)){ DEMO = true; return; }
  try {
    _app = initializeApp(cfg);
    _db  = getDatabase(_app);
    _fs  = getFirestore(_app);
    onValue(ref(_db, '.info/connected'), s => {
      const el = document.getElementById('conn-status');
      if (el) el.textContent = s.val() ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹';
    });
    DEMO = false;
  } catch(e) {
    DEMO = true;
    console.warn('Firebase init failed:', e);
  }
}

_initFirebase(_savedCfg);

// â”€â”€â”€ Timeout wrapper Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function withTimeout(promise, ms=8000, fallback=null) {
  const timeout = new Promise((_,reject) =>
    setTimeout(() => reject(new Error('timeout')), ms)
  );
  return Promise.race([promise, timeout]).catch(e => {
    if (e.message === 'timeout' || e.code === 'PERMISSION_DENIED' || e.message?.includes('permission')) {
      DEMO = true;
      const el = document.getElementById('conn-status');
      if (el) el.textContent = 'ğŸŸ¡ Ù…Ø­Ù„ÙŠ';
    }
    if (fallback !== null) return fallback;
    throw e;
  });
}

// â”€â”€â”€ DEMO helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _dg(path) {
  const d = JSON.parse(localStorage.getItem(_DK)||'{}');
  return path.split('/').filter(Boolean).reduce((c,p)=>c?.[p], d) ?? null;
}
function _ds(path, val) {
  const d = JSON.parse(localStorage.getItem(_DK)||'{}');
  const parts = path.split('/').filter(Boolean);
  let c = d;
  for (let i=0;i<parts.length-1;i++){if(!c[parts[i]])c[parts[i]]={};c=c[parts[i]];}
  c[parts[parts.length-1]] = val;
  localStorage.setItem(_DK, JSON.stringify(d));
  _bc.postMessage({p: path});
}
function _dd(path) {
  const d = JSON.parse(localStorage.getItem(_DK)||'{}');
  const parts = path.split('/').filter(Boolean);
  let c = d;
  for (let i=0;i<parts.length-1;i++){if(!c[parts[i]])return;c=c[parts[i]];}
  delete c[parts[parts.length-1]];
  localStorage.setItem(_DK, JSON.stringify(d));
}

// â”€â”€â”€ Firebase wrappers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dbGet(path) {
  if (DEMO) return _dg(path);
  try {
    const s = await withTimeout(get(ref(_db, path)), 7000, null);
    if (s === null) return _dg(path); // fallback to local
    return s.exists() ? s.val() : null;
  } catch(e) {
    DEMO = true;
    return _dg(path);
  }
}
async function dbSet(path, val) {
  if (DEMO) { _ds(path, val); return; }
  try {
    await withTimeout(set(ref(_db, path), val), 7000);
  } catch(e) {
    DEMO = true;
    _ds(path, val);
  }
}
async function dbUpdate(path, val) {
  if (DEMO) { const c=_dg(path)||{}; _ds(path,{...c,...val}); return; }
  try {
    await withTimeout(update(ref(_db, path), val), 7000);
  } catch(e) {
    DEMO = true;
    const c=_dg(path)||{}; _ds(path,{...c,...val});
  }
}
async function dbRemove(path) {
  if (DEMO) { _dd(path); return; }
  try {
    await withTimeout(remove(ref(_db, path)), 7000);
  } catch(e) {
    DEMO = true;
    _dd(path);
  }
}
function dbListen(path, cb) {
  if (DEMO) {
    cb(_dg(path));
    const h = e => { if(e.data?.p?.startsWith(path.split('/').slice(0,3).join('/'))) cb(_dg(path)); };
    _bc.addEventListener('message', h);
    return () => _bc.removeEventListener('message', h);
  }
  const unsub = onValue(ref(_db, path), s => cb(s.exists()?s.val():null));
  return unsub;
}
async function fsSet(col, id, data) {
  if (DEMO) { _ds(`_fs/${col}/${id}`, data); return; }
  try {
    await withTimeout(setDoc(doc(_fs, col, id), data), 8000);
  } catch(e) {
    DEMO = true;
    _ds(`_fs/${col}/${id}`, data);
  }
}
async function fsGet(col, id) {
  if (DEMO) return _dg(`_fs/${col}/${id}`);
  try {
    const s = await withTimeout(getDoc(doc(_fs, col, id)), 7000, null);
    if (s === null) return _dg(`_fs/${col}/${id}`);
    return s.exists() ? s.data() : null;
  } catch(e) {
    DEMO = true;
    return _dg(`_fs/${col}/${id}`);
  }
}
async function fsDel(col, id) {
  if (DEMO) { _dd(`_fs/${col}/${id}`); return; }
  try {
    await withTimeout(deleteDoc(doc(_fs, col, id)), 7000);
  } catch(e) {
    DEMO = true;
    _dd(`_fs/${col}/${id}`);
  }
}

// â”€â”€â”€ Image helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function compressImg(dataUrl, maxW=200, maxH=200, q=0.75) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => {
      let w=img.width, h=img.height;
      if(w>maxW){h=Math.round(h*maxW/w);w=maxW;}
      if(h>maxH){w=Math.round(w*maxH/h);h=maxH;}
      const c=document.createElement('canvas');
      c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      res(c.toDataURL('image/jpeg',q));
    };
    img.onerror = ()=>res(dataUrl);
    img.src = dataUrl;
  });
}
async function saveAvatar(username, dataUrl) {
  if (!dataUrl) return '';
  const compressed = await compressImg(dataUrl);
  await fsSet('avatars', username, { imageData: compressed, updatedAt: Date.now() });
  return compressed;
}
async function loadAvatar(username) {
  if (!username) return '';
  const d = await fsGet('avatars', username);
  return d?.imageData || '';
}

// â”€â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _actx;

function playAlarm(type='incoming') {
  try {
    if (!_actx) _actx = new (window.AudioContext||window.webkitAudioContext)();
    if (_actx.state==='suspended') _actx.resume();
    const ctx = _actx;

    if (type === 'incoming') {
      // ğŸ”Š ØµÙˆØª Ø·ÙˆØ§Ø±Ø¦ Ø¹Ø§Ù„Ù Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†Ù
      playLoudEmergencyAlarm(ctx, 10);
    } else if (type === 'send') {
      // ØµÙˆØª Ø¥Ø±Ø³Ø§Ù„ Ø®ÙÙŠÙ
      [[440,0,.08],[550,.1,.08],[660,.2,.1]].forEach(([f,s,d])=>{
        const o=ctx.createOscillator(), g=ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.type='sine'; o.frequency.value=f;
        g.gain.setValueAtTime(0.2,ctx.currentTime+s);
        g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+s+d);
        o.start(ctx.currentTime+s); o.stop(ctx.currentTime+s+d+0.05);
      });
    }
  } catch(e){ console.warn('Audio:',e); }
}

function playLoudEmergencyAlarm(ctx, duration=10) {
  // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¥Ù†Ø°Ø§Ø± Ø·ÙˆØ§Ø±Ø¦ Ø¹Ø§Ù„Ù ÙˆÙ…ØªØµØ§Ø¹Ø¯
  const masterGain = ctx.createGain();
  masterGain.gain.setValueAtTime(0.8, ctx.currentTime);
  masterGain.connect(ctx.destination);

  // Ø·Ø¨Ù‚Ø© 1: Ù†ØºÙ…Ø© Ø¥Ù†Ø°Ø§Ø± Ø±Ø¦ÙŠØ³ÙŠØ© (Ùˆailing siren effect)
  const siren = ctx.createOscillator();
  const sirenGain = ctx.createGain();
  siren.connect(sirenGain); sirenGain.connect(masterGain);
  siren.type = 'sawtooth';
  sirenGain.gain.value = 0.6;

  // ØªØ°Ø¨Ø°Ø¨ ØµÙˆØª Ø§Ù„Ø³Ø§ÙŠØ±Ù† Ø¨ÙŠÙ† 600 Ùˆ 1200 Hz
  for (let t = 0; t < duration; t += 0.6) {
    siren.frequency.setValueAtTime(600, ctx.currentTime + t);
    siren.frequency.linearRampToValueAtTime(1200, ctx.currentTime + t + 0.3);
    siren.frequency.linearRampToValueAtTime(600, ctx.currentTime + t + 0.6);
  }
  siren.start(ctx.currentTime);
  siren.stop(ctx.currentTime + duration);

  // Ø·Ø¨Ù‚Ø© 2: Ù†Ø¨Ø¶Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
  for (let i = 0; i < duration * 4; i++) {
    const beep = ctx.createOscillator();
    const beepGain = ctx.createGain();
    beep.connect(beepGain); beepGain.connect(masterGain);
    beep.type = 'square';
    beep.frequency.value = i % 2 === 0 ? 880 : 1100;
    const t = ctx.currentTime + i * 0.25;
    beepGain.gain.setValueAtTime(0, t);
    beepGain.gain.linearRampToValueAtTime(0.3, t + 0.02);
    beepGain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
    beep.start(t); beep.stop(t + 0.22);
  }

  // Ø·Ø¨Ù‚Ø© 3: ØµÙˆØª Ù…Ù†Ø®ÙØ¶ Ù„Ù„Ø¹Ù…Ù‚
  const bass = ctx.createOscillator();
  const bassGain = ctx.createGain();
  bass.connect(bassGain); bassGain.connect(masterGain);
  bass.type = 'sine';
  bassGain.gain.value = 0.25;
  for (let t = 0; t < duration; t += 0.5) {
    bass.frequency.setValueAtTime(120, ctx.currentTime + t);
    bass.frequency.linearRampToValueAtTime(200, ctx.currentTime + t + 0.25);
  }
  bass.start(ctx.currentTime);
  bass.stop(ctx.currentTime + duration);
}

function stopAlarmLoop() {
  clearInterval(alarmInterval);
  clearTimeout(alarmTimeout);
  alarmInterval = null;
  alarmTimeout = null;
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ù„Ù€ 10 Ø«ÙˆØ§Ù†Ù Ø«Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØºÙ„Ù‚ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø±Ù†ÙŠÙ† ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
function startAlarmLoop() {
  stopAlarmLoop();
  if (!_actx) _actx = new (window.AudioContext||window.webkitAudioContext)();
  if (_actx.state==='suspended') _actx.resume();

  // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø©
  playLoudEmergencyAlarm(_actx, 10);
  vib([500,200,500,200,500,200,500,200,500,200,1000]);

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØºÙ„Ù‚
  alarmInterval = setInterval(() => {
    if (!activeAlert) { stopAlarmLoop(); return; }
    if (_actx.state==='suspended') _actx.resume();
    playLoudEmergencyAlarm(_actx, 10);
    vib([500,200,500,200,500,200,500,200,500,200,1000]);
  }, 15000);
}

function vib(p){if(navigator.vibrate)navigator.vibrate(p);}

// â”€â”€â”€ Permissions System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function reqNotif(){
  if('Notification' in window && Notification.permission==='default'){
    await Notification.requestPermission();
  }
}

// Ø·Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function requestAllPermissions(){
  // 1. Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)
  if('Notification' in window && Notification.permission === 'default'){
    const res = await Notification.requestPermission();
    if(res !== 'granted'){
      showToast('âš ï¸ ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', 'warning');
    }
  }

  // 2. Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ÙŠÙØ·Ù„Ø¨ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ù„ÙƒÙ† Ù†Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹)
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      () => {}, // ØªÙ…
      (err) => {
        if(err.code === 1){ // PERMISSION_DENIED
          showToast('âš ï¸ ÙØ¹Ù‘Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§ØªÙƒ Ø¹Ù†Ø¯ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', 'warning');
        }
      },
      { timeout: 5000, maximumAge: 60000 }
    );
  }

  // 3. WakeLock (Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¶Ø§Ø¡Ø© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ù†Ø¯Ø§Ø¡)
  if(navigator.wakeLock){
    try { await navigator.wakeLock.request('screen'); } catch(e){}
  }
}
function sendNotif(title, body){
  if('Notification' in window && Notification.permission==='granted'){
    const n = new Notification(title, {
      body,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸš¨</text></svg>',
      requireInteraction: true,  // ÙŠØ¨Ù‚Ù‰ Ø­ØªÙ‰ ÙŠØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      silent: false,
      vibrate: [500, 200, 500, 200, 500],
      tag: 'rescue-alert',       // ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
      renotify: true
    });
    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: Ø£Ø­Ø¶Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø£Ù…Ø§Ù…
    n.onclick = () => {
      window.focus();
      n.close();
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù†Ø´Ø·Ø§Ù‹ Ø£Ø¸Ù‡Ø±Ù‡
      if(activeAlert) _showAlertScreen(activeAlert);
    };
  }
}

// â”€â”€ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('visibilitychange', () => {
  if(document.visibilityState === 'visible' && activeAlert){
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¸Ø§Ù‡Ø±Ø©
    const modal = $('alert-modal');
    if(modal && !modal.classList.contains('show')){
      _showAlertScreen(activeAlert);
      startAlarmLoop();
    }
  }
});

// â”€â”€â”€ Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let CU = null; // current user
let alertUnsub = null;
let presInterval = null;
let friends = {};
let friendsData = {};
let selectedTarget = 'all';        // 'all' | 'custom'
let selectedTargets = new Set();   // usernames when custom
let pressInt = null, pressP = 0;
let activeAlert = null;
let alarmInterval = null;          // repeat alarm interval
let alarmTimeout = null;           // alarm stop timeout
let avatarDataUrl = '';
let editAvatarDataUrl = '';

function _genToken(){ return Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function loadSess(){const s=localStorage.getItem('_rsc_sess');if(!s)return null;try{return JSON.parse(atob(s));}catch{return null;}}
function saveSess(u){const tok=_genToken();u._tok=tok;localStorage.setItem('_rsc_sess',btoa(JSON.stringify(u)));sessionStorage.setItem('_rsc_tok',tok);}
function clearSess(){localStorage.removeItem('_rsc_sess');sessionStorage.removeItem('_rsc_tok');}
function _verifySess(sess){ if(!sess?._tok) return true; const st=sessionStorage.getItem('_rsc_tok'); return !st||st===sess._tok; }

// â”€â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);

function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = $('screen-'+name);
  if(el) el.classList.add('active');
}
function showLoading(msg='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'){
  $('loading-overlay').style.display='flex';
  $('loading-msg').textContent=msg;
}
function hideLoading(){$('loading-overlay').style.display='none';}
function showToast(msg,type='success'){
  const t=document.createElement('div');
  t.className=`toast toast-${type}`;
  t.innerHTML=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add('show'),10);
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),400);},3200);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REGISTER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initRegister(){
  showScreen('register');
  avatarDataUrl='';
  $('reg-avatar-img').style.display='none';
  $('reg-avatar-icon').style.display='flex';
  $('reg-name').value='';
  $('reg-username').value='';
  $('reg-pass').value='';
  $('reg-pass2').value='';
  $('username-preview').textContent='';

  $('reg-avatar-btn').onclick=()=>$('reg-avatar-file').click();
  $('reg-avatar-file').onchange=async e=>{
    const f=e.target.files[0]; if(!f)return;
    const r=new FileReader();
    r.onload=async ev=>{
      avatarDataUrl=ev.target.result;
      $('reg-avatar-img').src=avatarDataUrl;
      $('reg-avatar-img').style.display='block';
      $('reg-avatar-icon').style.display='none';
    };
    r.readAsDataURL(f);
  };
  $('reg-username').addEventListener('input',()=>{
    const v=$('reg-username').value.replace(/[^a-z0-9_]/g,'');
    $('reg-username').value=v;
    $('username-preview').textContent=v?`@${v}`:'';
  });
  $('reg-submit').onclick=handleRegister;
  $('go-login').onclick=()=>showScreen('login');
}

async function handleRegister(){
  const name=$('reg-name').value.trim();
  const username=$('reg-username').value.trim().toLowerCase();
  const pass=$('reg-pass').value;
  const pass2=$('reg-pass2').value;
  if(!name) return showToast('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨','error');
  if(!username||username.length<3) return showToast('Ø§Ù„ÙŠÙˆØ²Ø± 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error');
  if(!/^[a-z0-9_]+$/.test(username)) return showToast('Ø§Ù„ÙŠÙˆØ²Ø±: Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… Ùˆ _ ÙÙ‚Ø·','error');
  if(!pass||pass.length<6) return showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error');
  if(pass!==pass2) return showToast('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªØ§Ù†','error');

  try {
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...');

    const existing = await dbGet(`users/${username}`);
    if(existing) { hideLoading(); return showToast('Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆØ²Ø± Ù…Ø­Ø¬ÙˆØ²ØŒ Ø§Ø®ØªØ± Ø¢Ø®Ø±','error'); }

    // Save avatar (with fallback if Firestore fails)
    let avatarUrl = '';
    if (avatarDataUrl) {
      try { avatarUrl = await saveAvatar(username, avatarDataUrl); }
      catch { avatarUrl = avatarDataUrl; } // keep local copy if upload fails
    }

    const passHash = await sha256(pass + username);
    const user = {
      name, username, passHash,
      avatar: DEMO ? avatarUrl : '', // store URL ref only in Firebase
      friends: {},
      createdAt: Date.now(),
      online: true,
      lastSeen: Date.now(),
    };
    await dbSet(`users/${username}`, user);
    user.avatar = avatarUrl; // keep full image in memory
    CU = user;
    saveSess({username, passHash});
    hideLoading();

    if (DEMO) showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ (ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ)', 'warning');
    else showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!');

    initMain();
  } catch(e){
    hideLoading();
    const msg = e.message?.includes('timeout')
      ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Firebase'
      : e.message?.includes('permission') || e.message?.includes('PERMISSION')
      ? 'Ø®Ø·Ø£ ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Firebase â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ Rules'
      : 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + (e.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
    showToast(msg, 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initLogin(){
  showScreen('login');
  $('login-username').value='';
  $('login-pass').value='';
  $('login-submit').onclick=handleLogin;
  $('go-register').onclick=initRegister;
}

async function handleLogin(){
  const username=$('login-username').value.trim().toLowerCase();
  const pass=$('login-pass').value;
  if(!username) return showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙŠÙˆØ²Ø±','error');
  if(!pass) return showToast('Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','error');

  try {
    _checkRL('login_'+username);
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    const user = await dbGet(`users/${username}`);
    if(!user){ hideLoading(); return showToast('Ø§Ù„ÙŠÙˆØ²Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error'); }

    const passHash = await sha256(pass + username);
    if(user.passHash !== passHash){ hideLoading(); return showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©','error'); }

    // Load avatar from Firestore (best-effort)
    try {
      const av = await loadAvatar(username);
      user.avatar = av || user.avatar || '';
    } catch { user.avatar = user.avatar || ''; }

    try { await dbUpdate(`users/${username}`,{online:true, lastSeen:Date.now()}); } catch{}
    CU = user;
    _clearRL('login_'+username);
    saveSess({username, passHash: user.passHash});
    hideLoading();
    initMain();
  } catch(e){
    hideLoading();
    const msg = e.message?.includes('timeout')
      ? 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª'
      : e.message?.includes('permission') || e.message?.includes('PERMISSION')
      ? 'Ø®Ø·Ø£ ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Firebase â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ Rules'
      : 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (e.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
    showToast(msg, 'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MAIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMain(){
  showScreen('main');
  updateTopbar();
  loadFriends();
  startPresence();
  requestAllPermissions(); // Ø·Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª ÙÙˆØ±Ø§Ù‹
  initSosBtn();
  initTabs();
  listenUsersOnline();

  if(alertUnsub) { alertUnsub(); alertUnsub = null; }

  // â”€â”€ Ø§Ø³ØªÙ…Ø§Ø¹ ÙÙˆØ±ÙŠ Ø¨Ù€ onChildAdded Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· â”€â”€â”€â”€â”€â”€
  if (!DEMO) {
    const alertsQuery = query(ref(_db, 'alerts'), orderByChild('timestamp'), limitToLast(30));
    // Ù†ØªØ¬Ø§Ù‡Ù„ Ø£ÙˆÙ„ batch ØªØ§Ø±ÙŠØ®ÙŠØ©ØŒ Ù†Ø³ØªÙ…Ø¹ ÙÙ‚Ø· Ù„Ù„Ø¬Ø¯ÙŠØ¯Ø©
    let _initialLoad = true;
    let _initialCount = 0;
    let _seenCount = 0;

    // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ø­Ø³Ø¨ ÙƒÙ… alert Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹
    get(ref(_db, 'alerts')).then(snap => {
      _initialCount = snap.exists() ? Object.keys(snap.val()).length : 0;
      _initialLoad = false;
    }).catch(() => { _initialLoad = false; });

    alertUnsub = onChildAdded(alertsQuery, snap => {
      if (!snap.exists() || !CU) return;
      _seenCount++;
      // ØªØ®Ø·Ù‘ÙŠ Ø§Ù„Ù€ alerts Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© ÙÙŠ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
      if (_initialLoad || _seenCount <= _initialCount) return;
      const a = snap.val();
      const id = snap.key;
      _processIncomingAlert(id, a);
    });
  } else {
    // DEMO mode fallback
    alertUnsub = dbListen('alerts', alerts => {
      if(!alerts||!CU) return;
      const pending = Object.entries(alerts)
        .filter(([id,a]) => _shouldShowAlert(id, a))
        .sort(([,a],[,b]) => b.timestamp - a.timestamp);
      if(pending.length > 0 && !activeAlert) {
        const [id, a] = pending[0];
        showIncomingAlert({id,...a});
      }
    });
  }

  if(DEMO) {
    $('conn-status').textContent='ğŸŸ¡ Ù…Ø­Ù„ÙŠ';
    setTimeout(()=>showToast('ğŸ“´ ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠØ§Ù‹ â€” Ø£Ø¶Ù Firebase Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©','warning'), 500);
  }
}

function updateTopbar(){
  if(!CU) return;
  $('topbar-name').textContent=CU.name;
  $('topbar-username').textContent='@'+CU.username;
  setAvatarEl($('topbar-avatar'), CU.avatar, CU.name);
}

function setAvatarEl(el, avatar, name){
  if(!el) return;
  if(avatar){
    el.style.backgroundImage=`url(${avatar})`;
    el.textContent='';
  } else {
    el.style.backgroundImage='none';
    el.textContent=(name||'?')[0].toUpperCase();
  }
}

// â”€â”€â”€ Presence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPresence(){
  if(!CU) return;
  clearInterval(presInterval);
  presInterval = setInterval(()=>{
    if(CU) dbUpdate(`users/${CU.username}`,{online:true,lastSeen:Date.now()});
  }, 25000);
  const goOff=()=>{ if(CU) dbUpdate(`users/${CU.username}`,{online:false,lastSeen:Date.now()}); };
  window.addEventListener('beforeunload',goOff);
  window.addEventListener('pagehide',goOff);
}

// â”€â”€â”€ Friends â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadFriends(){
  dbListen(`users/${CU.username}/friends`, data=>{
    friends = data||{};
    CU.friends = friends;
    const sess=loadSess(); if(sess){sess.friends=friends;saveSess(sess);}
    updateTargetSelector();
    renderFriendsList();
    updateBadge();
  });
}
function listenUsersOnline(){
  dbListen('users', users=>{
    if(!users) return;
    Object.keys(friends).forEach(u=>{ if(users[u]) friendsData[u]=users[u]; });
    renderFriendsList();
    updateTargetSelector();
  });
}
function updateBadge(){
  const n=Object.keys(friends).length;
  const b=$('friends-badge');
  if(b){b.textContent=n; b.style.display=n>0?'flex':'none';}
}

async function addFriend(uname){
  uname=uname.toLowerCase().trim();
  if(uname===CU.username) throw new Error('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ');
  const target=await dbGet(`users/${uname}`);
  if(!target) throw new Error('Ø§Ù„ÙŠÙˆØ²Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const already=await dbGet(`users/${CU.username}/friends/${uname}`);
  if(already) throw new Error('Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ');
  const av = await loadAvatar(uname);
  await dbSet(`users/${CU.username}/friends/${uname}`,{
    username:uname, name:target.name,
    avatar: av || target.avatar || '',
    addedAt:Date.now()
  });
  return target;
}
async function removeFriend(uname){
  await dbRemove(`users/${CU.username}/friends/${uname}`);
  delete friends[uname];
  if(selectedTarget===uname) selectedTarget='all';
  updateTargetSelector();
}

function _makeTapBtn(classes, html, onTap){
  const btn = document.createElement('button');
  btn.className = classes;
  btn.innerHTML = html;
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… pointerdown Ù„Ø£Ø³Ø±Ø¹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
  // Ù†ØªØ¬Ù†Ø¨ ØªÙ…Ø§Ù…Ø§Ù‹ touchstart+click Ù„Ø£Ù†Ù‡Ù…Ø§ ÙŠØ³Ø¨Ø¨Ø§Ù† ØªÙƒØ±Ø§Ø±Ø§Ù‹
  btn.addEventListener('pointerdown', e=>{
    e.preventDefault();
    onTap();
  });
  return btn;
}

function updateTargetSelector(){
  const c=$('target-selector'); if(!c) return;
  c.innerHTML='';

  const isAll = selectedTarget === 'all';
  const customCount = selectedTargets.size;

  let btnLabel;
  if (isAll) {
    btnLabel=`<span>ğŸŒ</span><span>Ø§Ù„Ø¬Ù…ÙŠØ¹</span><span class="tgt-count">${Object.keys(friends).length}</span>`;
  } else {
    btnLabel=`<span>ğŸ¯</span><span>Ù…Ø®ØµØµ</span><span class="tgt-count tgt-count-custom">${customCount}</span>`;
  }

  const allBtn = _makeTapBtn('target-btn'+(isAll||selectedTarget==='custom'?' active':''), btnLabel, openTargetModal);
  c.appendChild(allBtn);

  if (selectedTarget === 'custom') {
    selectedTargets.forEach(u=>{
      const f=friends[u]; if(!f) return;
      const isOn=friendsData[u]?.online;
      const av = f.avatar
        ? `<img src="${f.avatar}" class="tgt-av">`
        : `<span class="tgt-init">${(f.name||u)[0].toUpperCase()}</span>`;
      const chip = _makeTapBtn('target-btn active',
        `<span class="tgt-wrap">${av}<span class="odot ${isOn?'on':'off'}"></span></span><span>@${u}</span>`,
        openTargetModal);
      c.appendChild(chip);
    });
  }
}

// â”€â”€â”€ Ø§ØªØµØ§Ù„ 911 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function call911(){
  // ÙŠÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ù‚Ù… Ù…ÙƒØªÙˆØ¨Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  window.location.href = 'tel:911';
}
window.call911 = call911;

// â”€â”€â”€ Target Selection Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ù†Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙˆÙ†Ø¯ÙŠØ± Ø§Ù„Ø¸Ù‡ÙˆØ±/Ø§Ù„Ø¥Ø®ÙØ§Ø¡ ÙÙ‚Ø·
let _tmodRendered = false;

function openTargetModal(){
  // Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† CSS transition)
  renderTargetModal();
  // Ø£Ø¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ â€” display:flex ÙŠØ¸Ù‡Ø± + Ø§Ù„Ù€ card ØªÙ†Ø²Ù„Ù‚ Ù„Ù„Ø£Ø¹Ù„Ù‰
  $('target-modal').classList.add('show');
}

function closeTargetModal(){
  $('target-modal').classList.remove('show');
  updateTargetSelector();
}

function renderTargetModal(){
  const list=$('target-modal-list'); if(!list) return;

  // Ø¨Ù†Ø§Ø¡ HTML ÙƒØ§Ù…Ù„Ø§Ù‹ Ø¯ÙØ¹Ø©Ù‹ ÙˆØ§Ø­Ø¯Ø© (Ø£Ø³Ø±Ø¹ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† createElement Ø§Ù„Ù…ØªÙƒØ±Ø±)
  const friendEntries = Object.entries(friends);
  if(!friendEntries.length){
    list.innerHTML='<div class="empty-state" style="padding:20px">ğŸ‘¥<br>Ø£Ø¶Ù Ø£ØµØ¯Ù‚Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹</div>';
    return;
  }

  const allSelected = selectedTarget === 'all';
  let html = `
    <div class="tmod-row${allSelected?' tmod-selected':''}" data-action="all">
      <div class="tmod-av" style="background:rgba(255,34,68,.15);font-size:20px">ğŸŒ</div>
      <div class="tmod-info">
        <div class="tmod-name">Ø§Ù„Ø¬Ù…ÙŠØ¹</div>
        <div class="tmod-sub">${friendEntries.length} Ø£ØµØ¯Ù‚Ø§Ø¡</div>
      </div>
      <div class="tmod-check${allSelected?' checked':''}"></div>
    </div>`;

  friendEntries.forEach(([u,f])=>{
    const isOn = friendsData[u]?.online;
    const isSelected = selectedTarget==='all' || selectedTargets.has(u);
    const chk = isSelected && selectedTarget!=='all';
    const avHTML = f.avatar
      ? `<img src="${f.avatar}" class="tmod-av-img" loading="eager">`
      : `<div class="tmod-av">${(f.name||u)[0].toUpperCase()}</div>`;
    html += `
      <div class="tmod-row${chk?' tmod-selected':''}" data-action="user" data-u="${u}">
        <div class="tmod-av-wrap">
          ${avHTML}
          <span class="odot ${isOn?'on':'off'}" style="position:absolute;bottom:1px;right:1px;width:10px;height:10px;border:2px solid #0d0018"></span>
        </div>
        <div class="tmod-info">
          <div class="tmod-name">${f.name}</div>
          <div class="tmod-sub">@${u} Â· ${isOn?'<span style="color:#00ff88">Ù…ØªØµÙ„</span>':'ØºÙŠØ± Ù…ØªØµÙ„'}</div>
        </div>
        <div class="tmod-check${chk?' checked':''}"></div>
      </div>`;
  });

  list.innerHTML = html;

  // Ø­Ø¯Ø« ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø­Ø¯Ø« Ù„ÙƒÙ„ ØµÙ (Event Delegation)
  list.onpointerdown = (e) => {
    const row = e.target.closest('[data-action]');
    if (!row) return;
    e.preventDefault();

    // ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© Ø¨ØµØ±ÙŠØ© ÙÙˆØ±ÙŠØ©
    row.style.opacity = '0.75';
    setTimeout(() => row.style.opacity = '', 120);

    const action = row.dataset.action;
    if (action === 'all') {
      selectedTarget = 'all';
      selectedTargets.clear();
    } else {
      const u = row.dataset.u;
      if (selectedTarget === 'all') {
        selectedTarget = 'custom';
        selectedTargets.clear();
        selectedTargets.add(u);
      } else {
        if (selectedTargets.has(u)) {
          selectedTargets.delete(u);
          if (selectedTargets.size === 0) selectedTarget = 'all';
        } else {
          selectedTargets.add(u);
          selectedTarget = 'custom';
        }
      }
    }
    renderTargetModal();
    updateTargetSelector();
  };
}

function renderFriendsList(){
  const c=$('friends-list-container'); if(!c) return;
  if(!Object.keys(friends).length){
    c.innerHTML='<div class="empty-state">ğŸ‘¥<br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯<br><small>Ø£Ø¶Ù Ø£ØµØ¯Ù‚Ø§Ø¡Ùƒ Ø¹Ø¨Ø± Ø§Ù„ÙŠÙˆØ²Ø±</small></div>';
    return;
  }
  c.innerHTML='';
  Object.entries(friends).forEach(([u,f])=>{
    const isOn=friendsData[u]?.online;
    const ls=friendsData[u]?.lastSeen;
    const div=document.createElement('div');
    div.className='friend-item';
    div.innerHTML=`
      <div class="fav-wrap">
        ${f.avatar?`<img src="${f.avatar}" class="fav-img">`:`<div class="fav-ph">${(f.name||u)[0].toUpperCase()}</div>`}
        <span class="odot ${isOn?'on':'off'}" style="position:absolute;bottom:1px;right:1px;width:12px;height:12px;border:2px solid var(--bg)"></span>
      </div>
      <div class="finfo">
        <div class="fname">${f.name}</div>
        <div class="funm">@${u} Â· ${isOn?'<span style="color:#00ff88">Ù…ØªØµÙ„</span>':ls?timeAgo(ls):''}</div>
      </div>
      <div class="factions">
        <button class="sos-to-btn" onclick="sosDirect('${u}')">ğŸš¨</button>
        <button class="rm-btn" onclick="removeFriendUI('${u}')">âœ•</button>
      </div>`;
    c.appendChild(div);
  });
}

async function handleAddFriend(){
  const u=_sanitize($('add-friend-input').value).trim().toLowerCase();
  if(!u) return;
  try {
    showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...');
    const f=await addFriend(u);
    hideLoading();
    $('add-friend-input').value='';
    showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${f.name} âœ…`);
    playAlarm('send');
  } catch(e){ hideLoading(); showToast(e.message,'error'); }
}
async function removeFriendUI(u){
  if(!confirm(`Ø­Ø°Ù @${u} Ù…Ù† Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ØŸ`)) return;
  await removeFriend(u);
  showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

// â”€â”€â”€ SOS Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSosBtn(){
  const btn=$('sos-circle'); if(!btn) return;
  let pressed=false;
  const start=()=>{
    if(pressed) return; pressed=true;
    pressP=0; btn.classList.add('pressing');
    clearInterval(pressInt);
    pressInt=setInterval(()=>{
      pressP+=1.5; updateRing(pressP);
      if(pressP>=100){
        clearInterval(pressInt); pressed=false;
        btn.classList.remove('pressing'); updateRing(0);
        triggerSOS();
      }
    },30);
  };
  const cancel=()=>{
    if(!pressed) return; pressed=false;
    clearInterval(pressInt); pressP=0; updateRing(0);
    btn.classList.remove('pressing');
  };
  btn.addEventListener('mousedown',start);
  btn.addEventListener('touchstart',e=>{e.preventDefault();start();},{passive:false});
  btn.addEventListener('mouseup',cancel);
  btn.addEventListener('mouseleave',cancel);
  btn.addEventListener('touchend',cancel);
  btn.addEventListener('touchcancel',cancel);
}

function updateRing(pct){
  const c=$('prg-circle'); if(!c) return;
  const circ=2*Math.PI*90;
  c.style.strokeDashoffset = circ-(pct/100)*circ;
  c.style.stroke = pct>66?'#ff0022':pct>33?'#ff6600':'#ff3366';
}

async function triggerSOS(){
  showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...');

  // Always try to get location
  const loc = await new Promise(r=>{
    if(!navigator.geolocation) return r(null);
    navigator.geolocation.getCurrentPosition(
      p=>r({lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy}),
      ()=>r(null),
      {timeout:6000, enableHighAccuracy:true}
    );
  });

  showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦...');

  try {
    const ts = Date.now();
    const baseAlert = {
      from:CU.username, fromName:CU.name, fromAvatar:CU.avatar||'',
      message:`ğŸš¨ ${CU.name} ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„Ø©!`,
      lat:loc?.lat||null, lng:loc?.lng||null, acc:loc?.acc||null,
      timestamp:ts, responded:{}
    };

    if (selectedTarget === 'all') {
      // Send one alert for all friends
      const alert = { ...baseAlert, targetType:'all', targetUsername:'' };
      if(DEMO){ _ds(`alerts/${ts}`, alert); }
      else { const r=push(ref(_db,'alerts')); await set(r,alert); }
    } else if (selectedTarget === 'custom' && selectedTargets.size > 0) {
      // Send individual alert per selected person
      let i = 0;
      for (const uname of selectedTargets) {
        const alert = { ...baseAlert, targetType:'user', targetUsername:uname, timestamp:ts+i };
        if(DEMO){ _ds(`alerts/${ts+i}`, alert); }
        else { const r=push(ref(_db,'alerts')); await set(r,alert); }
        i++;
      }
    } else {
      // Fallback
      const alert = { ...baseAlert, targetType:'all', targetUsername:'' };
      if(DEMO){ _ds(`alerts/${ts}`, alert); }
      else { const r=push(ref(_db,'alerts')); await set(r,alert); }
    }

    hideLoading();
    playAlarm('send');
    vib([200,100,200,100,500]);

    const targetLabel = selectedTarget==='all'
      ? 'Ø§Ù„Ø¬Ù…ÙŠØ¹'
      : selectedTarget==='custom'
      ? `${selectedTargets.size} Ø£Ø´Ø®Ø§Øµ`
      : '@'+selectedTarget;
    const locLabel = loc ? ' ğŸ“ Ù…Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹' : ' âš ï¸ Ø¨Ø¯ÙˆÙ† Ù…ÙˆÙ‚Ø¹';
    showToast(`ğŸš¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø¥Ù„Ù‰ ${targetLabel}${locLabel}`, 'sos');

    const btn=$('sos-circle');
    btn.classList.add('alert-active');
    setTimeout(()=>btn.classList.remove('alert-active'),5000);
  } catch(e){
    hideLoading();
    showToast('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: '+e.message,'error');
  }
}

async function sosDirect(u){
  selectedTarget=u; updateTargetSelector(); await triggerSOS();
}

// â”€â”€â”€ Incoming Alert System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let shownAlertIds = new Set();
let countdownInt  = null;
let ringInt       = null;
let reriseTimer   = null;

// â”€â”€ ÙÙ„ØªØ±: Ù‡Ù„ ÙŠØ¬Ø¨ Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ØŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _shouldShowAlert(id, a) {
  if (!a || !CU) return false;
  if (a.from === CU.username) return false;
  const isFriend = !!(CU.friends || {})[a.from];
  const forMe = (a.targetType === 'all' && isFriend)
             || (a.targetType === 'user' && a.targetUsername === CU.username);
  if (!forMe) return false;
  if (a.responded?.[CU.username]) return false;
  if (Date.now() - a.timestamp > 180000) return false; // 3 Ø¯Ù‚Ø§Ø¦Ù‚ max
  if (shownAlertIds.has(id)) return false;
  return true;
}

// â”€â”€ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ÙˆØ§Ø±Ø¯ Ù…Ù† Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _processIncomingAlert(id, a) {
  if (!_shouldShowAlert(id, a)) return;
  showIncomingAlert({ id, ...a });
}

// â”€â”€ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showIncomingAlert(alert) {
  if (shownAlertIds.has(alert.id)) return;
  shownAlertIds.add(alert.id);
  activeAlert = alert;

  // 1. ØµÙˆØª + Ø§Ù‡ØªØ²Ø§Ø²
  startAlarmLoop();

  // 2. Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
  _sendRichNotif(alert);

  // 3. Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  _fillAlertCard(alert);

  // 4. Ø£Ø¸Ù‡Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹
  _showAlertScreen(alert);
}

function _fillAlertCard(alert) {
  $('al-name').textContent = alert.fromName || alert.from;
  $('al-user').textContent = '@' + alert.from;
  $('al-msg').textContent  = alert.message || 'ğŸš¨ ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„Ø©!';
  $('al-time').textContent = new Date(alert.timestamp).toLocaleTimeString('ar');
  setAvatarEl($('al-avatar'), alert.fromAvatar, alert.fromName);

  const hasLoc = alert.lat && alert.lng;
  if (hasLoc) {
    $('al-coords').textContent = `ğŸ“ ${Number(alert.lat).toFixed(5)}, ${Number(alert.lng).toFixed(5)}`;
    $('al-coords').style.display = 'block';
    $('al-loc-btn').style.display = 'flex';
    $('al-loc-btn').onclick = () =>
      window.open(`https://maps.google.com/?q=${alert.lat},${alert.lng}`, '_blank');
  } else {
    $('al-coords').style.display = 'none';
    $('al-loc-btn').style.display = 'none';
  }

  // Ø²Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
  $('al-respond').onclick = () => acceptAlert(alert);

  // Ø²Ø± Ø§Ù„ØªØ¬Ø§Ù‡Ù„ â€” ÙŠØ®ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø± ÙŠØ¹ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 15Ø«
  $('al-dismiss').onclick = () => {
    _hideAlertScreen();
    clearTimeout(reriseTimer);
    reriseTimer = setTimeout(() => {
      if (activeAlert && activeAlert.id === alert.id) {
        startAlarmLoop();
        _showAlertScreen(alert);
      }
    }, 15000);
  };
}

function _showAlertScreen(alert) {
  const modal = $('alert-modal');
  modal.style.display = 'flex';
  // Force reflow
  modal.offsetHeight;
  modal.classList.add('show');
  _startRingProgressBar(10);
  _startCountdown();

  // â”€â”€ ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø´Ø§Ø´Ø© â”€â”€
  modal.classList.add('flash');
  setTimeout(() => modal.classList.remove('flash'), 600);
}

function _hideAlertScreen() {
  clearInterval(ringInt);
  clearInterval(countdownInt);
  $('alert-modal').classList.remove('show');
}

function _startRingProgressBar(seconds) {
  clearInterval(ringInt);
  const bar = $('al-ring-progress');
  if (!bar) return;
  let elapsed = 0;
  const step = 80;
  const total = seconds * 1000;
  bar.style.transition = 'none';
  bar.style.width = '100%';
  ringInt = setInterval(() => {
    elapsed += step;
    const pct = Math.max(0, 100 - (elapsed / total) * 100);
    bar.style.width = pct + '%';
    if (elapsed >= total) clearInterval(ringInt);
  }, step);
}

function _startCountdown() {
  clearInterval(countdownInt);
  const el = $('al-countdown');
  if (!el) return;
  let sec = 10;
  el.textContent = `ğŸ”Š ÙŠØ±Ù†... (${sec}Ø«)`;
  el.style.color = '#ff3366';
  countdownInt = setInterval(() => {
    sec--;
    if (sec > 0) {
      el.textContent = `ğŸ”Š ÙŠØ±Ù†... (${sec}Ø«)`;
    } else {
      clearInterval(countdownInt);
      el.textContent = 'ğŸ” Ø³ÙŠØ¹ÙˆØ¯ Ø¨Ø¹Ø¯ 15Ø« Ø¥Ø°Ø§ Ù„Ù… ØªØ³ØªØ¬Ø¨';
      el.style.color = '#ff9900';
    }
  }, 1000);
}

// â”€â”€ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙ†ÙŠ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function _sendRichNotif(alert) {
  sendNotif('ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦!', `${alert.fromName} ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„Ø©!`);
  // â”€â”€ Ø­Ø§ÙˆÙ„ Wake Lock Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¶Ø§Ø¡Ø© â”€â”€
  try {
    if (navigator.wakeLock) {
      await navigator.wakeLock.request('screen');
    }
  } catch(e) {}
  // â”€â”€ Ø­Ø§ÙˆÙ„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© â”€â”€
  if (document.visibilityState === 'hidden') {
    try {
      // ÙŠØ´ØºÙ‘Ù„ ØµÙˆØª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ø¨Ø± Web Audio
      if (!_actx) _actx = new (window.AudioContext||window.webkitAudioContext)();
      if (_actx.state === 'suspended') await _actx.resume();
    } catch(e) {}
  }
}

// â”€â”€ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ø¯Ø§Ø¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function acceptAlert(alert) {
  // 1. Ø£ÙˆÙ‚Ù ÙƒÙ„ Ø´ÙŠØ¡
  stopAlarmLoop();
  clearInterval(ringInt);
  clearInterval(countdownInt);
  clearTimeout(reriseTimer);
  if (navigator.vibrate) navigator.vibrate(0);

  // 2. Ø§ØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©
  activeAlert = null;
  $('alert-modal').classList.remove('show');

  // 3. Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙŠ Firebase
  try {
    if (!DEMO && alert.id) {
      const u = {};
      u[`responded/${CU.username}`] = { name: CU.name, at: Date.now() };
      await update(ref(_db, `alerts/${alert.id}`), u);
    }
  } catch(e) {}

  // 4. Ø§Ø¹Ø±Ø¶ toast Ø«Ù… Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  if (alert.lat && alert.lng) {
    showToast(`âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… â€” Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù…ÙˆÙ‚Ø¹ ${alert.fromName}`, 'success');
    setTimeout(() => {
      window.open(`https://maps.google.com/?q=${alert.lat},${alert.lng}`, '_blank');
    }, 400);
  } else {
    showToast(`âœ… Ø§Ø³ØªÙ„Ù…Øª Ù†Ø¯Ø§Ø¡ ${alert.fromName} â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹`, 'warning');
  }
}

async function dismissAlert(id) {
  stopAlarmLoop();
  clearInterval(ringInt);
  clearInterval(countdownInt);
  clearTimeout(reriseTimer);
  try {
    if (!DEMO && id) {
      const u = {};
      u[`responded/${CU.username}`] = { name: CU.name, at: Date.now() };
      await update(ref(_db, `alerts/${id}`), u);
    }
  } catch(e) {}
  activeAlert = null;
  $('alert-modal').classList.remove('show');
  if (navigator.vibrate) navigator.vibrate(0);
}

function hideAlertScreen() { _hideAlertScreen(); }

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initTabs(){
  ['home','friends','history','profile'].forEach(t=>{
    $(` tab-${t}`);
    $('tab-'+t).onclick=()=>switchTab(t);
  });
  switchTab('home');
}
function switchTab(t){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  $('tab-'+t).classList.add('active');
  $('content-'+t).classList.add('active');
  if(t==='history') loadHistory();
  if(t==='profile') loadProfileTab();
}

// â”€â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadHistory(){
  const c=$('history-container'); if(!c) return;
  c.innerHTML='<div class="loading-spin"></div>';
  dbListen('alerts', alerts=>{
    if(!alerts){ c.innerHTML='<div class="empty-state">ğŸ“‹<br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</div>'; return; }
    const mine=Object.entries(alerts)
      .filter(([,a])=>{
        if(!a) return false;
        const sent=a.from===CU.username;
        const recv=(a.targetType==='all'&&!!(friends[a.from]))||(a.targetType==='user'&&a.targetUsername===CU.username);
        return sent||recv;
      })
      .sort(([,a],[,b])=>b.timestamp-a.timestamp).slice(0,30);
    if(!mine.length){ c.innerHTML='<div class="empty-state">ğŸ“‹<br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„</div>'; return; }
    c.innerHTML='';
    mine.forEach(([,a])=>{
      const sent=a.from===CU.username;
      const d=document.createElement('div');
      d.className=`history-item ${sent?'sent':'recv'}`;
      d.innerHTML=`
        <div style="font-size:22px">${sent?'ğŸ“¤':'ğŸ“¥'}</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:14px">${sent?'Ø£Ø±Ø³Ù„Øª Ù†Ø¯Ø§Ø¡Ù‹':'Ù†Ø¯Ø§Ø¡ Ù…Ù† '+a.fromName}</div>
          <div style="font-size:11px;color:var(--t2);margin-top:3px">
            ${new Date(a.timestamp).toLocaleString('ar')} Â· Ø¥Ù„Ù‰: ${a.targetType==='all'?'Ø§Ù„Ø¬Ù…ÙŠØ¹':'@'+a.targetUsername}
          </div>
          ${a.lat?`<a href="https://maps.google.com/?q=${a.lat},${a.lng}" target="_blank" class="loc-link">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>`:''}
        </div>`;
      c.appendChild(d);
    });
  });
}

// â”€â”€â”€ Profile Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadProfileTab(){
  if(!CU) return;
  $('pf-name').textContent=CU.name;
  $('pf-username').textContent='@'+CU.username;
  $('pf-joined').textContent='Ø§Ù†Ø¶Ù… '+new Date(CU.createdAt||Date.now()).toLocaleDateString('ar');
  $('pf-friends-n').textContent=Object.keys(friends).length;
  setAvatarEl($('pf-avatar'), CU.avatar, CU.name);
}

// â”€â”€â”€ Edit Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openEditProfile(){
  editAvatarDataUrl = CU.avatar || '';
  $('edit-name').value=CU.name;
  $('edit-username').value=CU.username;
  $('edit-username-preview').textContent='@'+CU.username;
  setAvatarEl($('edit-avatar-disp'), CU.avatar, CU.name);
  $('edit-modal').style.display='flex';
  $('edit-modal').classList.add('show');

  $('edit-avatar-btn').onclick=()=>$('edit-avatar-file').click();
  $('edit-avatar-file').onchange=async e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=async ev=>{
      editAvatarDataUrl=ev.target.result;
      const el=$('edit-avatar-disp');
      el.style.backgroundImage=`url(${editAvatarDataUrl})`;
      el.textContent='';
    };
    reader.readAsDataURL(f);
  };
  $('edit-username').addEventListener('input',()=>{
    const v=$('edit-username').value.replace(/[^a-z0-9_]/g,'');
    $('edit-username').value=v;
    $('edit-username-preview').textContent=v?`@${v}`:'';
  });
  $('edit-save').onclick=saveEditProfile;
  $('edit-close').onclick=()=>{ $('edit-modal').style.display='none'; };
}

async function saveEditProfile(){
  const newName=$('edit-name').value.trim();
  const newUser=$('edit-username').value.trim().toLowerCase();
  if(!newName) return showToast('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨','error');
  if(!newUser||newUser.length<3) return showToast('Ø§Ù„ÙŠÙˆØ²Ø± 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„','error');
  if(!/^[a-z0-9_]+$/.test(newUser)) return showToast('Ø§Ù„ÙŠÙˆØ²Ø±: Ø£Ø­Ø±Ù ÙˆØ£Ø±Ù‚Ø§Ù… Ùˆ _ ÙÙ‚Ø·','error');

  try {
    showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
    const oldUser=CU.username;

    // Check username uniqueness if changed
    if(newUser!==oldUser){
      const existing=await dbGet(`users/${newUser}`);
      if(existing){ hideLoading(); return showToast('Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆØ²Ø± Ù…Ø­Ø¬ÙˆØ²','error'); }
    }

    // Handle avatar change
    let newAvatar=CU.avatar||'';
    if(editAvatarDataUrl && editAvatarDataUrl!==CU.avatar){
      newAvatar=await saveAvatar(newUser, editAvatarDataUrl);
    }

    // If username changed: copy data to new key, delete old
    if(newUser!==oldUser){
      const userData=await dbGet(`users/${oldUser}`);
      userData.name=newName;
      userData.username=newUser;
      userData.avatar=newAvatar;
      await dbSet(`users/${newUser}`, userData);
      await dbRemove(`users/${oldUser}`);
      // Move avatar in Firestore
      if(editAvatarDataUrl!==CU.avatar){
        await fsDel('avatars', oldUser);
      }
      // Update friends lists of others (best-effort)
      // Update session
      CU={...userData};
    } else {
      await dbUpdate(`users/${oldUser}`,{name:newName, avatar:newAvatar});
      CU.name=newName;
      CU.avatar=newAvatar;
    }
    CU.username=newUser;

    saveSess({username:newUser, passHash:CU.passHash});
    hideLoading();
    $('edit-modal').style.display='none';
    updateTopbar();
    loadProfileTab();
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…');
  } catch(e){
    hideLoading();
    showToast('Ø®Ø·Ø£: '+e.message,'error');
  }
}

// â”€â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logout(){
  if(!confirm('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) return;
  if(CU) dbUpdate(`users/${CU.username}`,{online:false,lastSeen:Date.now()});
  clearInterval(presInterval);
  if(alertUnsub) alertUnsub();
  clearSess();
  CU=null; friends={}; friendsData={}; selectedTarget='all';
  initLogin();
}

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(ts){
  const d=Date.now()-ts;
  if(d<60000) return 'Ù…Ù†Ø° Ù„Ø­Ø¸Ø©';
  if(d<3600000) return `Ù…Ù†Ø° ${Math.floor(d/60000)} Ø¯`;
  if(d<86400000) return `Ù…Ù†Ø° ${Math.floor(d/3600000)} Ø³`;
  return `Ù…Ù†Ø° ${Math.floor(d/86400000)} ÙŠ`;
}

// â”€â”€â”€ Startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

window.handleAddFriend=handleAddFriend;
window.removeFriendUI=removeFriendUI;
window.sosDirect=sosDirect;
window.logout=logout;
window.dismissAlert=dismissAlert;
window.openEditProfile=openEditProfile;
window.switchTab=switchTab;
window.initLogin=initLogin;
window.initRegister=initRegister;
window.openTargetModal=openTargetModal;
window.closeTargetModal=closeTargetModal;
window.acceptAlert=acceptAlert;

document.addEventListener('DOMContentLoaded', async ()=>{
  await new Promise(r=>setTimeout(r,1800));

  // Firebase Ù…ÙØ¹Ø¯Ù‘ Ù…Ø³Ø¨Ù‚Ø§Ù‹ â€” ØªØ®Ø·Ù‘ÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹
  const sess=loadSess();
  if(sess?.username && _verifySess(sess)){
    try {
      showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
      const user=await dbGet(`users/${sess.username}`);
      if(user && user.passHash===sess.passHash){
        try {
          const av=await loadAvatar(sess.username);
          user.avatar=av||user.avatar||'';
        } catch{ user.avatar=user.avatar||''; }
        try { await dbUpdate(`users/${sess.username}`,{online:true,lastSeen:Date.now()}); } catch{}
        CU=user;
        hideLoading();
        initMain();
      } else {
        // If DEMO mode and no user found, restore from local session
        if(DEMO && sess.username){
          const localUser = _dg(`users/${sess.username}`);
          if(localUser){
            CU=localUser;
            hideLoading();
            initMain();
            return;
          }
        }
        clearSess();
        hideLoading();
        initLogin();
      }
    } catch(e){
      hideLoading();
      // Still try to show login even on error
      initLogin();
    }
  } else {
    initLogin();
  }
});
</script>

<style>
:root{
  --red:#ff2244;--red2:#ff6688;--green:#00ff88;--cyan:#00ffcc;
  --bg:#060008;--card:rgba(255,255,255,0.04);--border:rgba(255,34,68,0.25);
  --text:#fff;--t2:#888;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);
  font-family:'Cairo',sans-serif;overflow:hidden;position:fixed;top:0;left:0;}

/* BG glow */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 10%,rgba(255,34,68,.12) 0%,transparent 60%),
    radial-gradient(ellipse 50% 60% at 80% 90%,rgba(0,255,136,.06) 0%,transparent 60%),
    radial-gradient(ellipse 40% 40% at 60% 40%,rgba(100,0,255,.04) 0%,transparent 60%);
  animation:bgP 8s ease-in-out infinite;}
@keyframes bgP{0%,100%{opacity:1}50%{opacity:.7}}

/* SCREENS */
.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;z-index:1;overflow-y:auto;}
.screen.active{display:flex;}

/* SPLASH */
#screen-splash{gap:18px;}
.spl-logo{font-size:86px;animation:sFloat 3s ease-in-out infinite;filter:drop-shadow(0 0 28px rgba(255,34,68,.8));}
.spl-title{font-family:'Orbitron',monospace;font-size:36px;font-weight:900;color:var(--red);
  text-shadow:0 0 28px var(--red),0 0 56px rgba(255,34,68,.4);letter-spacing:6px;}
.spl-sub{color:var(--t2);font-size:14px;}
.spl-dots{display:flex;gap:10px;margin-top:16px;}
.spl-dot{width:10px;height:10px;border-radius:50%;background:var(--red);box-shadow:0 0 10px var(--red);animation:dp 1.2s ease-in-out infinite;}
.spl-dot:nth-child(2){animation-delay:.2s}.spl-dot:nth-child(3){animation-delay:.4s}

/* AUTH SCREENS */
#screen-register,#screen-login{padding:20px;overflow-y:auto;justify-content:flex-start;padding-top:30px;}
.auth-card{background:rgba(255,255,255,.03);border:1px solid var(--border);backdrop-filter:blur(28px);
  -webkit-backdrop-filter:blur(28px);border-radius:24px;padding:28px 22px;
  width:100%;max-width:400px;display:flex;flex-direction:column;align-items:center;gap:12px;
  animation:slideUp .5s ease;}
.auth-logo{font-family:'Orbitron',monospace;font-size:24px;font-weight:900;color:var(--red);
  text-shadow:0 0 18px var(--red);letter-spacing:4px;margin-bottom:2px;}
.auth-sub{color:var(--t2);font-size:13px;text-align:center;}
.auth-switch{color:var(--t2);font-size:13px;text-align:center;margin-top:4px;}
.auth-switch a{color:var(--cyan);cursor:pointer;text-decoration:underline;}

/* Avatar picker */
.av-pick{width:86px;height:86px;border-radius:50%;background:rgba(255,34,68,.08);
  border:2px dashed rgba(255,34,68,.4);display:flex;align-items:center;justify-content:center;
  cursor:pointer;position:relative;overflow:hidden;transition:all .3s;flex-shrink:0;}
.av-pick:hover{border-color:var(--red);background:rgba(255,34,68,.15);}
.av-pick img{width:100%;height:100%;object-fit:cover;position:absolute;border-radius:50%;}
.av-pick-icon{font-size:30px;}

/* Inputs */
.ig{width:100%;position:relative;}
.il{color:var(--t2);font-size:12px;margin-bottom:5px;display:block;}
.inp{width:100%;padding:12px 15px;background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);border-radius:12px;color:#fff;
  font-size:14px;font-family:'Cairo',sans-serif;outline:none;direction:rtl;
  transition:border .2s,box-shadow .2s;}
.inp:focus{border-color:rgba(255,34,68,.5);box-shadow:0 0 14px rgba(255,34,68,.15);}
.uname-prev{position:absolute;left:14px;top:50%;transform:translateY(-50%);
  color:rgba(255,34,68,.7);font-size:12px;font-weight:600;}

/* Buttons */
.btn-main{width:100%;padding:14px;background:linear-gradient(135deg,#ff2244,#cc0033);
  border:none;border-radius:13px;color:#fff;font-size:15px;font-weight:700;
  font-family:'Cairo',sans-serif;cursor:pointer;letter-spacing:1px;
  box-shadow:0 0 22px rgba(255,34,68,.4),0 4px 14px rgba(0,0,0,.4);transition:all .2s;}
.btn-main:hover{transform:translateY(-1px);box-shadow:0 0 32px rgba(255,34,68,.6);}
.btn-sec{width:100%;padding:12px;background:rgba(255,34,68,.1);border:1px solid rgba(255,34,68,.3);
  border-radius:13px;color:var(--red);font-size:14px;font-weight:700;
  font-family:'Cairo',sans-serif;cursor:pointer;transition:all .2s;}
.btn-sec:hover{background:rgba(255,34,68,.2);}

/* MAIN */
#screen-main{justify-content:flex-start;padding:0;}

/* Topbar */
.topbar{width:100%;padding:13px 16px;display:flex;align-items:center;justify-content:space-between;
  background:rgba(0,0,0,.45);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(255,34,68,.12);z-index:10;flex-shrink:0;}
.tb-user{display:flex;align-items:center;gap:10px;cursor:pointer;}
.tb-av{width:40px;height:40px;border-radius:50%;background:rgba(255,34,68,.15);
  border:2px solid rgba(255,34,68,.5);display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:15px;color:var(--red);background-size:cover;background-position:center;}
.tb-info{line-height:1.2;}
.tb-name{font-size:13px;font-weight:700;}
.tb-uname{font-size:11px;color:var(--t2);}
.tb-logo{font-family:'Orbitron',monospace;font-size:17px;font-weight:900;color:var(--red);
  letter-spacing:3px;text-shadow:0 0 14px var(--red);}
.conn-ind{font-size:11px;color:var(--t2);background:rgba(255,255,255,.05);padding:3px 8px;border-radius:20px;}

/* Status bar */
.status-bar{width:100%;padding:5px 16px;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.st-dot{width:7px;height:7px;border-radius:50%;background:var(--green);
  box-shadow:0 0 8px var(--green);animation:dp 2s ease-in-out infinite;}
.st-txt{font-size:12px;color:var(--green);}

/* Tabs content */
.tabs-content{flex:1;overflow:hidden;width:100%;}
.tab-content{display:none;height:100%;overflow-y:auto;flex-direction:column;}
.tab-content.active{display:flex;}

/* HOME */
#content-home{align-items:center;padding:10px 18px 18px;gap:10px;}
.target-sec{width:100%;}
.target-lbl{font-size:11px;color:var(--t2);text-align:center;margin-bottom:7px;}
.target-selector{display:flex;gap:7px;overflow-x:auto;padding-bottom:3px;justify-content:center;flex-wrap:wrap;}
.target-selector::-webkit-scrollbar{display:none;}
.target-btn{padding:6px 12px;border-radius:20px;cursor:pointer;font-size:11px;font-weight:600;
  font-family:'Cairo',sans-serif;display:flex;align-items:center;gap:5px;white-space:nowrap;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);color:var(--t2);transition:all .2s;
  touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;}
.target-btn.active{background:rgba(255,34,68,.2);border-color:var(--red);color:var(--red);
  box-shadow:0 0 10px rgba(255,34,68,.25);}
.tgt-wrap{position:relative;width:20px;height:20px;}
.tgt-av,.tgt-init{width:20px;height:20px;border-radius:50%;object-fit:cover;
  display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;
  background:rgba(255,34,68,.2);color:var(--red);}
.odot{width:8px;height:8px;border-radius:50%;border:1.5px solid var(--bg);}
.odot.on{background:var(--green);box-shadow:0 0 6px var(--green);}
.odot.off{background:#555;}

/* SOS */
.sos-container{flex:1;display:flex;align-items:center;justify-content:center;position:relative;width:100%;min-height:240px;}
.sos-rings{position:absolute;width:280px;height:280px;}
.sos-ring{position:absolute;border-radius:50%;border:1.5px solid rgba(255,34,68,.15);animation:rExp 3s ease-out infinite;}
.sos-ring:nth-child(1){inset:30px;animation-delay:0s}
.sos-ring:nth-child(2){inset:10px;animation-delay:.6s}
.sos-ring:nth-child(3){inset:-10px;animation-delay:1.2s}
.sos-ring:nth-child(4){inset:-30px;animation-delay:1.8s}
.prg-svg{position:absolute;width:228px;height:228px;transform:rotate(-90deg);pointer-events:none;z-index:2;}
#prg-circle{stroke-dasharray:565.5;stroke-dashoffset:565.5;stroke-linecap:round;transition:stroke-dashoffset .03s linear,stroke .2s;}
.sos-circle{width:168px;height:168px;border-radius:50%;position:relative;z-index:3;
  background:radial-gradient(circle,rgba(255,34,68,.12) 0%,rgba(10,0,20,.8) 65%);
  border:3px solid rgba(255,34,68,.45);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;user-select:none;
  box-shadow:0 0 32px rgba(255,34,68,.25),0 0 65px rgba(255,34,68,.1),inset 0 0 28px rgba(255,34,68,.08);
  animation:sFloat 4s ease-in-out infinite;transition:all .15s;}
.sos-circle:hover{box-shadow:0 0 48px rgba(255,34,68,.4),0 0 96px rgba(255,34,68,.15),inset 0 0 38px rgba(255,34,68,.12);}
.sos-circle.pressing{transform:scale(.95);box-shadow:0 0 65px rgba(255,34,68,.6),0 0 130px rgba(255,34,68,.25),inset 0 0 48px rgba(255,34,68,.2);}
.sos-circle.alert-active{animation:sosA .4s ease-in-out infinite;border-color:var(--red);}
.sos-icon{font-size:42px;line-height:1;}
.sos-lbl{font-size:13px;font-weight:700;color:var(--red);text-shadow:0 0 10px var(--red);margin-top:5px;letter-spacing:1px;}
.sos-hint{font-size:10px;color:rgba(255,34,68,.5);margin-top:2px;}
.sos-hint-bar{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);
  border-radius:11px;padding:9px 14px;width:100%;text-align:center;font-size:12px;color:var(--t2);}

/* Target count badge on button */
.tgt-count{background:rgba(255,34,68,.3);color:var(--red);border-radius:10px;
  padding:1px 6px;font-size:10px;font-weight:700;margin-right:2px;}
.tgt-count-custom{background:rgba(255,150,0,.3);color:#ffaa00;}

/* TARGET MODAL */
.tmod-overlay{
  position:fixed;inset:0;z-index:9990;
  background:rgba(0,0,0,.88);
  display:none;align-items:flex-end;justify-content:center;
  -webkit-tap-highlight-color:transparent;
}
.tmod-overlay.show{
  display:flex;
}
.tmod-card{
  width:100%;max-width:480px;
  background:linear-gradient(180deg,#0f0020 0%,#080012 100%);
  border:1px solid rgba(255,34,68,.25);border-radius:24px 24px 0 0;
  max-height:82vh;display:flex;flex-direction:column;
  transform:translateY(100%);
  transition:transform .22s cubic-bezier(.25,1,.4,1);
  will-change:transform;
  -webkit-overflow-scrolling:touch;
}
.tmod-overlay.show .tmod-card{transform:translateY(0);}
.tmod-head{padding:18px 18px 12px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;}
.tmod-title{font-size:16px;font-weight:700;}
.tmod-subtitle{font-size:11px;color:var(--t2);margin-top:2px;}
.tmod-close{background:rgba(255,255,255,.06);border:none;color:#aaa;
  width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:14px;}
.tmod-body{overflow-y:auto;padding:10px 14px 24px;flex:1;}
.tmod-row{display:flex;align-items:center;gap:12px;padding:12px 10px;border-radius:14px;
  margin-bottom:6px;cursor:pointer;transition:all .18s;
  border:1.5px solid rgba(255,255,255,.05);background:rgba(255,255,255,.02);}
.tmod-row:hover{background:rgba(255,34,68,.06);border-color:rgba(255,34,68,.2);}
.tmod-row.tmod-selected{background:rgba(255,34,68,.1);border-color:rgba(255,34,68,.4);}
.tmod-av-wrap{position:relative;width:46px;height:46px;flex-shrink:0;}
.tmod-av{width:46px;height:46px;border-radius:50%;background:rgba(255,34,68,.15);
  border:2px solid rgba(255,34,68,.3);display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:700;color:var(--red);}
.tmod-av-img{width:46px;height:46px;border-radius:50%;object-fit:cover;
  border:2px solid rgba(255,34,68,.3);}
.tmod-info{flex:1;min-width:0;}
.tmod-name{font-weight:700;font-size:14px;}
.tmod-sub{font-size:11px;color:var(--t2);margin-top:2px;}
.tmod-check{width:22px;height:22px;border-radius:50%;
  border:2px solid rgba(255,255,255,.2);flex-shrink:0;transition:all .2s;
  display:flex;align-items:center;justify-content:center;}
.tmod-check.checked{background:var(--red);border-color:var(--red);}
.tmod-check.checked::after{content:'âœ“';color:#fff;font-size:12px;font-weight:900;}
.tmod-confirm{width:calc(100% - 28px);margin:10px 14px 16px;padding:14px;
  background:linear-gradient(135deg,#ff2244,#cc0033);border:none;border-radius:13px;
  color:#fff;font-size:15px;font-weight:700;font-family:'Cairo',sans-serif;cursor:pointer;
  box-shadow:0 0 20px rgba(255,34,68,.4);}

/* ØªØ­Ø°ÙŠØ± Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
.tmod-warning{
  margin:0 14px;
  padding:10px 14px;
  background:rgba(255,165,0,.08);
  border:1px solid rgba(255,165,0,.25);
  border-radius:12px;
  font-size:12px;
  color:rgba(255,200,80,.9);
  text-align:center;
  line-height:1.6;
  flex-shrink:0;
}

/* Alert countdown */
.al-countdown{font-size:12px;font-weight:700;margin-top:6px;letter-spacing:.5px;}
.al-coords{font-size:11px;color:var(--cyan);margin-top:4px;display:none;}

/* Bottom nav */
.bottom-nav{
  width:100%;display:flex;align-items:flex-end;
  background:rgba(6,0,12,.92);backdrop-filter:blur(28px);
  -webkit-backdrop-filter:blur(28px);
  border-top:1px solid rgba(255,34,68,.15);
  flex-shrink:0;position:relative;
  padding-bottom:env(safe-area-inset-bottom,0px);
}
.tab-btn{flex:1;padding:10px 0 13px;display:flex;flex-direction:column;align-items:center;gap:3px;
  background:none;border:none;cursor:pointer;color:var(--t2);transition:all .2s;font-family:'Cairo',sans-serif;position:relative;}
.tab-btn .ti{font-size:21px;}
.tab-btn .tl{font-size:10px;}
.tab-btn.active{color:var(--red);}
.tab-btn.active .ti{filter:drop-shadow(0 0 7px var(--red));}
.friends-badge{position:absolute;top:4px;right:calc(50% - 18px);background:var(--red);color:#fff;
  width:17px;height:17px;border-radius:50%;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;}

/* Ø²Ø± 911 ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø´Ø±ÙŠØ· */
.nav-911-wrap{
  flex:0 0 auto;width:72px;
  display:flex;flex-direction:column;align-items:center;
  position:relative;padding-bottom:13px;
  margin-top:-22px; /* ÙŠØ¹Ù„Ùˆ Ø¹Ù† Ø§Ù„Ø´Ø±ÙŠØ· */
}
.nav-911-btn{
  width:62px;height:62px;border-radius:50%;
  background:linear-gradient(145deg,#ff0022,#cc0018);
  border:3px solid rgba(255,60,80,.6);
  box-shadow:
    0 0 0 4px rgba(6,0,12,.92),
    0 0 20px rgba(255,0,34,.6),
    0 0 40px rgba(255,0,34,.25),
    inset 0 1px 0 rgba(255,255,255,.2);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;
  transition:transform .12s, box-shadow .12s;
  position:relative;
  animation:btn911Glow 2.5s ease-in-out infinite;
}
@keyframes btn911Glow{
  0%,100%{box-shadow:0 0 0 4px rgba(6,0,12,.92),0 0 20px rgba(255,0,34,.6),0 0 40px rgba(255,0,34,.25),inset 0 1px 0 rgba(255,255,255,.2);}
  50%{box-shadow:0 0 0 4px rgba(6,0,12,.92),0 0 30px rgba(255,0,34,.9),0 0 60px rgba(255,0,34,.45),inset 0 1px 0 rgba(255,255,255,.2);}
}
.nav-911-btn:active{transform:scale(.92);box-shadow:0 0 0 4px rgba(6,0,12,.92),0 0 10px rgba(255,0,34,.4),inset 0 1px 0 rgba(255,255,255,.15);}
.nav-911-num{font-family:'Orbitron',monospace;font-size:16px;font-weight:900;color:#fff;
  letter-spacing:1px;line-height:1;text-shadow:0 0 10px rgba(255,255,255,.5);}
.nav-911-sub{font-size:7.5px;color:rgba(255,255,255,.7);margin-top:1px;font-weight:700;letter-spacing:.5px;}
.nav-911-label{font-size:9px;color:rgba(255,60,60,.8);margin-top:4px;font-weight:700;letter-spacing:.5px;}

/* FRIENDS TAB */
#content-friends{padding:14px;gap:10px;}
.add-bar{display:flex;gap:8px;width:100%;}
.add-bar .inp{flex:1;margin-bottom:0;}
.btn-add{padding:12px 15px;background:rgba(255,34,68,.15);border:1px solid rgba(255,34,68,.4);
  border-radius:12px;color:var(--red);cursor:pointer;font-weight:700;font-family:'Cairo',sans-serif;font-size:13px;white-space:nowrap;}
.friends-wrap{flex:1;overflow-y:auto;width:100%;}
.friend-item{display:flex;align-items:center;gap:11px;padding:11px 0;border-bottom:1px solid rgba(255,255,255,.05);}
.fav-wrap{position:relative;flex-shrink:0;width:46px;height:46px;}
.fav-img{width:46px;height:46px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,34,68,.3);}
.fav-ph{width:46px;height:46px;border-radius:50%;background:rgba(255,34,68,.12);
  border:2px solid rgba(255,34,68,.3);display:flex;align-items:center;justify-content:center;
  font-size:17px;font-weight:700;color:var(--red);}
.finfo{flex:1;min-width:0;}
.fname{font-weight:700;font-size:14px;}
.funm{font-size:11px;color:var(--t2);margin-top:2px;}
.factions{display:flex;gap:7px;}
.sos-to-btn{background:rgba(255,34,68,.15);border:1px solid rgba(255,34,68,.3);
  border-radius:10px;width:36px;height:36px;cursor:pointer;font-size:15px;}
.rm-btn{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
  border-radius:10px;width:36px;height:36px;color:var(--t2);cursor:pointer;font-size:13px;}

/* HISTORY */
#content-history{padding:14px;}
.history-item{display:flex;align-items:flex-start;gap:11px;padding:12px 10px;margin-bottom:7px;
  border-radius:13px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);}
.history-item.sent{border-color:rgba(255,34,68,.15);}
.history-item.recv{border-color:rgba(0,255,136,.12);}
.loc-link{color:var(--cyan);font-size:11px;margin-top:4px;display:inline-block;}

/* PROFILE TAB */
#content-profile{padding:18px;align-items:center;}
.pf-card{width:100%;max-width:380px;background:rgba(255,255,255,.03);
  border:1px solid var(--border);border-radius:20px;padding:22px;
  display:flex;flex-direction:column;align-items:center;gap:8px;}
.pf-av{width:88px;height:88px;border-radius:50%;background:rgba(255,34,68,.12);
  border:3px solid rgba(255,34,68,.4);display:flex;align-items:center;justify-content:center;
  font-size:32px;font-weight:700;color:var(--red);background-size:cover;background-position:center;}
.pf-name{font-size:21px;font-weight:900;}
.pf-uname{color:var(--red);font-size:13px;}
.pf-joined{color:var(--t2);font-size:11px;}
.pf-stats{display:flex;gap:14px;width:100%;margin-top:8px;}
.stat-c{flex:1;background:rgba(255,34,68,.06);border:1px solid rgba(255,34,68,.15);
  border-radius:11px;padding:12px 6px;text-align:center;}
.stat-n{font-size:24px;font-weight:900;color:var(--red);}
.stat-l{font-size:11px;color:var(--t2);margin-top:3px;}
.btn-edit{width:100%;padding:13px;background:rgba(0,255,200,.08);border:1px solid rgba(0,255,200,.25);
  border-radius:13px;color:var(--cyan);font-size:14px;font-weight:700;
  font-family:'Cairo',sans-serif;cursor:pointer;margin-top:6px;}
.btn-logout{width:100%;padding:12px;background:rgba(255,34,68,.1);border:1px solid rgba(255,34,68,.3);
  border-radius:13px;color:var(--red);font-size:14px;font-weight:700;
  font-family:'Cairo',sans-serif;cursor:pointer;margin-top:4px;}

/* EDIT PROFILE MODAL */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);
  backdrop-filter:blur(10px);display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{animation:fadeIn .2s ease;}
.modal-card{width:100%;max-width:480px;background:linear-gradient(180deg,#0d0018 0%,#080012 100%);
  border:1px solid rgba(255,34,68,.2);border-radius:24px 24px 0 0;
  padding:24px 20px 32px;animation:slideIn .3s ease;max-height:90vh;overflow-y:auto;}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.modal-title{font-size:17px;font-weight:700;}
.modal-close{background:rgba(255,255,255,.06);border:none;color:#aaa;
  width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:15px;}
.edit-av-row{display:flex;align-items:center;gap:14px;margin-bottom:14px;}
.edit-av-disp{width:70px;height:70px;border-radius:50%;background:rgba(255,34,68,.12);
  border:2px solid rgba(255,34,68,.35);display:flex;align-items:center;justify-content:center;
  font-size:26px;font-weight:700;color:var(--red);background-size:cover;background-position:center;flex-shrink:0;}
.btn-change-av{padding:9px 16px;background:rgba(255,34,68,.12);border:1px solid rgba(255,34,68,.3);
  border-radius:10px;color:var(--red);cursor:pointer;font-size:13px;font-weight:600;
  font-family:'Cairo',sans-serif;}

/* INCOMING ALERT MODAL */
.alert-modal{
  position:fixed;inset:0;z-index:99999;
  background:rgba(0,0,0,0);
  display:none;align-items:center;justify-content:center;
  flex-direction:column;padding:16px;
  pointer-events:none;
}
.alert-modal.show{
  display:flex;
  background:rgba(0,0,8,.97);
  pointer-events:all;
  animation:alFadeIn .25s ease forwards;
}
@keyframes alFadeIn{from{opacity:0}to{opacity:1}}
.alert-modal.flash .alert-card{
  animation:alCardIn .35s cubic-bezier(.175,.885,.32,1.4) forwards,
            alPulse 0.4s ease 0.35s 2;
}
@keyframes alCardIn{
  from{transform:scale(.7) translateY(40px);opacity:0}
  to{transform:scale(1) translateY(0);opacity:1}
}
@keyframes alPulse{
  0%,100%{box-shadow:0 0 60px rgba(255,34,68,.5),0 0 120px rgba(255,34,68,.25),inset 0 0 40px rgba(255,34,68,.05);}
  50%{box-shadow:0 0 90px rgba(255,34,68,.9),0 0 180px rgba(255,34,68,.5),inset 0 0 60px rgba(255,34,68,.1);}
}
.alert-card{
  background:linear-gradient(160deg,rgba(255,34,68,.16) 0%,rgba(10,0,20,.98) 60%);
  border:2.5px solid var(--red);border-radius:28px;
  padding:0 0 20px;width:100%;max-width:370px;text-align:center;
  box-shadow:0 0 60px rgba(255,34,68,.5),0 0 120px rgba(255,34,68,.25),inset 0 0 40px rgba(255,34,68,.05);
  overflow:hidden;
  opacity:0;transform:scale(.7) translateY(40px);
}
.alert-modal.show .alert-card{
  animation:alCardIn .38s cubic-bezier(.175,.885,.32,1.4) forwards;
}

/* Ø´Ø±ÙŠØ· Ø±Ù†ÙŠÙ† Ø¹Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
.al-ring-bar{
  width:100%;height:8px;
  background:rgba(255,34,68,.12);
  margin-bottom:0;overflow:hidden;
}
.al-ring-progress{
  height:100%;
  background:linear-gradient(90deg,#ff0022,#ff6688,#ff0022);
  background-size:200% 100%;
  animation:alBarShimmer 1.5s linear infinite;
  transition:width .08s linear;
}
@keyframes alBarShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Header Ø§Ù„Ø£Ø­Ù…Ø± */
.al-header{
  background:linear-gradient(135deg,rgba(255,34,68,.25),rgba(180,0,40,.15));
  border-bottom:1px solid rgba(255,34,68,.2);
  padding:16px 20px 14px;
  display:flex;align-items:center;gap:12px;
  text-align:right;
}
.al-emoji{font-size:38px;line-height:1;animation:alBounce .5s ease infinite alternate;flex-shrink:0;}
@keyframes alBounce{from{transform:scale(1)}to{transform:scale(1.15) rotate(-5deg)}}
.al-header-text{flex:1;}
.al-sos-label{font-size:11px;font-weight:700;color:rgba(255,100,120,.8);letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;}

/* Avatar + Info */
.al-body{padding:16px 20px 4px;}
.al-av-row{display:flex;align-items:center;gap:14px;margin-bottom:12px;}
.al-av{
  width:70px;height:70px;border-radius:50%;flex-shrink:0;
  background:rgba(255,34,68,.15);
  border:3px solid var(--red);
  display:flex;align-items:center;justify-content:center;
  font-size:26px;font-weight:700;color:var(--red);
  background-size:cover;background-position:center;
  box-shadow:0 0 18px rgba(255,34,68,.5);
  animation:alAvatarPulse 1.5s ease infinite;
}
@keyframes alAvatarPulse{
  0%,100%{box-shadow:0 0 18px rgba(255,34,68,.5);}
  50%{box-shadow:0 0 32px rgba(255,34,68,.9),0 0 55px rgba(255,34,68,.35);}
}
.al-info{flex:1;text-align:right;}
.al-name{font-size:21px;font-weight:900;letter-spacing:.3px;}
.al-user{color:rgba(255,100,120,.75);font-size:12px;margin-top:1px;}
.al-msg{
  color:rgba(255,255,255,.9);font-size:14px;
  line-height:1.7;text-align:center;
  background:rgba(255,34,68,.07);border:1px solid rgba(255,34,68,.15);
  border-radius:12px;padding:10px 14px;margin-bottom:8px;
}
.al-time{color:var(--t2);font-size:11px;margin-bottom:4px;text-align:center;}
.al-countdown{
  font-size:13px;font-weight:700;margin:4px 0 8px;
  text-align:center;letter-spacing:.3px;
}
.al-coords{
  font-size:11px;color:var(--cyan);margin:4px 0;
  background:rgba(0,255,200,.06);border:1px solid rgba(0,255,200,.2);
  border-radius:8px;padding:6px 10px;text-align:center;
  display:none;
}

/* Ø£Ø²Ø±Ø§Ø± */
.al-btns{padding:0 18px;}
.al-respond{
  width:100%;padding:17px;margin-top:6px;
  background:linear-gradient(135deg,#00e060,#00aa44);
  border:none;border-radius:15px;color:#fff;
  font-size:17px;font-weight:900;
  font-family:'Cairo',sans-serif;cursor:pointer;
  box-shadow:0 4px 28px rgba(0,220,100,.5);
  transition:transform .12s,box-shadow .12s;
  letter-spacing:.5px;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.al-respond:active{transform:scale(.97);box-shadow:0 2px 14px rgba(0,220,100,.3);}
.al-loc-btn{
  display:none;align-items:center;justify-content:center;gap:7px;
  width:100%;padding:12px;margin-top:8px;
  background:rgba(0,255,200,.09);border:1px solid rgba(0,255,200,.3);
  border-radius:13px;color:var(--cyan);cursor:pointer;
  font-size:13px;font-weight:700;font-family:'Cairo',sans-serif;
  transition:background .15s;
}
.al-loc-btn:active{background:rgba(0,255,200,.18);}
.al-dismiss{
  width:100%;padding:12px;margin-top:8px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.09);
  border-radius:12px;color:rgba(255,255,255,.4);
  font-size:12px;font-family:'Cairo',sans-serif;cursor:pointer;
  transition:background .15s;
}
.al-dismiss:active{background:rgba(255,255,255,.08);}

/* Loading */
.loading-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.8);
  backdrop-filter:blur(10px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;}
.loading-spin{width:38px;height:38px;border-radius:50%;
  border:3px solid rgba(255,34,68,.15);border-top-color:var(--red);animation:spin .8s linear infinite;}
.loading-msg{color:var(--t2);font-size:14px;}

/* Toast */
.toast{position:fixed;top:76px;left:50%;transform:translateX(-50%) translateY(-18px);
  padding:9px 20px;border-radius:11px;font-size:13px;font-weight:600;z-index:999;
  opacity:0;transition:all .3s;white-space:nowrap;pointer-events:none;max-width:90vw;text-align:center;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast-success{background:rgba(0,255,136,.15);border:1px solid var(--green);color:var(--green);}
.toast-error{background:rgba(255,34,68,.15);border:1px solid var(--red);color:var(--red2);}
.toast-warning{background:rgba(255,165,0,.15);border:1px solid orange;color:orange;}
.toast-sos{background:rgba(255,34,68,.25);border:1px solid var(--red);color:#fff;font-size:15px;}

/* Empty */
.empty-state{color:var(--t2);text-align:center;padding:36px 18px;line-height:2;font-size:13px;}

/* FIREBASE SETUP SCREEN */
#screen-setup{padding:16px;overflow-y:auto;justify-content:flex-start;padding-top:20px;gap:0;}
.setup-card{
  background:rgba(255,255,255,.03);border:1px solid var(--border);
  backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);
  border-radius:22px;padding:22px 18px;width:100%;max-width:460px;
  display:flex;flex-direction:column;gap:12px;animation:slideUp .5s ease;
}
.setup-logo{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;
  color:var(--red);text-shadow:0 0 14px var(--red);letter-spacing:3px;text-align:center;}
.setup-title{font-size:15px;font-weight:700;text-align:center;margin-top:2px;}
.setup-desc{
  font-size:12px;color:var(--t2);text-align:center;line-height:1.7;
  background:rgba(255,255,255,.03);border-radius:10px;padding:10px 12px;
}
.setup-steps{
  background:rgba(0,255,200,.04);border:1px solid rgba(0,255,200,.15);
  border-radius:12px;padding:12px 14px;font-size:12px;line-height:2;color:rgba(255,255,255,.75);
}
.setup-steps b{color:var(--cyan);}
.setup-divider{border:none;border-top:1px solid rgba(255,255,255,.07);margin:4px 0;}
.setup-field-label{font-size:12px;color:var(--t2);margin-bottom:4px;display:block;}
.setup-field-req{color:var(--red);font-size:10px;margin-right:4px;}
.setup-rules{
  background:rgba(255,34,68,.06);border:1px solid rgba(255,34,68,.2);
  border-radius:10px;padding:10px 14px;font-size:11px;color:rgba(255,150,150,.9);
  line-height:1.9;font-family:monospace;direction:ltr;
}
.setup-reset{
  background:none;border:none;color:rgba(255,255,255,.3);
  font-size:11px;cursor:pointer;font-family:'Cairo',sans-serif;
  text-decoration:underline;text-align:center;padding:4px;
}
.loading-spin-sm{width:30px;height:30px;border-radius:50%;
  border:2px solid rgba(255,34,68,.15);border-top-color:var(--red);
  animation:spin .8s linear infinite;margin:30px auto;}

/* Scrollbar */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(255,34,68,.3);border-radius:2px;}

/* Animations */
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(28px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes slideIn{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes dp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.7)}}
@keyframes sFloat{0%,100%{transform:translateY(0) rotate(0deg)}25%{transform:translateY(-12px) rotate(1deg)}75%{transform:translateY(-8px) rotate(-1deg)}}
@keyframes rExp{0%{opacity:.4;transform:scale(.95)}50%{opacity:.1}100%{opacity:0;transform:scale(1.15)}}
@keyframes sosA{0%,100%{box-shadow:0 0 38px rgba(255,34,68,.6),0 0 75px rgba(255,34,68,.3),inset 0 0 28px rgba(255,34,68,.2)}50%{box-shadow:0 0 75px rgba(255,34,68,.9),0 0 150px rgba(255,34,68,.5),inset 0 0 55px rgba(255,34,68,.4)}}
@keyframes alFlash{0%,100%{background:rgba(0,0,0,.95)}50%{background:rgba(255,0,30,.12)}}
@keyframes alPulse{from{box-shadow:0 0 38px rgba(255,34,68,.3),0 0 75px rgba(255,34,68,.1)}to{box-shadow:0 0 65px rgba(255,34,68,.6),0 0 130px rgba(255,34,68,.2)}}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-7px)}}
</style>
<link rel="manifest" href="#" id="pwa-manifest">
<link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
<meta name="apple-mobile-web-app-title" content="RESCUE">
<meta name="application-name" content="RESCUE">
<meta name="msapplication-TileColor" content="#060008">
<meta name="msapplication-TileImage" content="/icon-192.png">
<meta name="description" content="Ù†Ø¸Ø§Ù… Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙÙˆØ±ÙŠ â€” Ø£Ø±Ø³Ù„ ÙˆØ§Ø³ØªÙ‚Ø¨Ù„ Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ">
<script>
// â”€â”€ Inline PWA Manifest with real PNG icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const manifest = {
    name: "RESCUE â€” Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦",
    short_name: "RESCUE",
    description: "Ù†Ø¸Ø§Ù… Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ",
    start_url: "/",
    scope: "/",
    display: "standalone",
    orientation: "portrait-primary",
    background_color: "#060008",
    theme_color: "#060008",
    lang: "ar",
    dir: "rtl",
    id: "/",
    categories: ["utilities", "lifestyle"],
    icons: [
      { src: "/icon-192.png", sizes: "192x192", type: "image/png", purpose: "any" },
      { src: "/icon-192.png", sizes: "192x192", type: "image/png", purpose: "maskable" },
      { src: "/icon-512.png", sizes: "512x512", type: "image/png", purpose: "any" },
      { src: "/icon-512.png", sizes: "512x512", type: "image/png", purpose: "maskable" }
    ],
    shortcuts: [
      {
        name: "Ø¥Ø±Ø³Ø§Ù„ Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦",
        short_name: "SOS",
        description: "Ø£Ø±Ø³Ù„ Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±ÙŠ",
        url: "/",
        icons: [{ src: "/icon-192.png", sizes: "192x192", type: "image/png" }]
      }
    ],
    prefer_related_applications: false
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
  document.getElementById('pwa-manifest').href = URL.createObjectURL(blob);
})();

// â”€â”€ Service Worker (Cache + Push Notifications) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  const icon192 = "/icon-192.png";
  const swCode = `
const CACHE = 'rescue-v2';
self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/'])));
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(ks =>
    Promise.all(ks.filter(k => k !== CACHE).map(k => caches.delete(k)))
  ));
  self.clients.claim();
});
self.addEventListener('fetch', e => {
  if(e.request.method !== 'GET') return;
  e.respondWith(
    fetch(e.request)
      .then(r => {
        if(r && r.status === 200) {
          const clone = r.clone();
          caches.open(CACHE).then(c => c.put(e.request, clone));
        }
        return r;
      })
      .catch(() => caches.match(e.request))
  );
});
self.addEventListener('push', e => {
  const d = e.data?.json() || {};
  e.waitUntil(self.registration.showNotification(d.title || 'ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦!', {
    body: d.body || 'Ø´Ø®Øµ ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„Ø¢Ù†!',
    icon: '${icon192}',
    badge: '${icon192}',
    vibrate: [500,200,500,200,500,200,1000],
    requireInteraction: true,
    tag: 'rescue-alert',
    renotify: true,
    data: d
  }));
});
self.addEventListener('notificationclick', e => {
  e.notification.close();
  e.waitUntil(clients.matchAll({type:'window',includeUncontrolled:true}).then(cs => {
    for(const c of cs) if(c.url.includes(self.location.origin)) { c.focus(); return; }
    clients.openWindow('/');
  }));
});
  `.replace(/\$\{icon192\}/g, icon192);

  const swBlob = new Blob([swCode], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(swBlob), {scope:'/'})
    .catch(()=>{});
}
</script>
</head>
<body>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spin"></div>
  <div class="loading-msg" id="loading-msg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- INCOMING ALERT -->
<div class="alert-modal" id="alert-modal">
  <div class="alert-card">
    <!-- Ø´Ø±ÙŠØ· Ø±Ù†ÙŠÙ† Ø¹Ù„ÙˆÙŠ -->
    <div class="al-ring-bar">
      <div class="al-ring-progress" id="al-ring-progress" style="width:100%"></div>
    </div>

    <!-- Header -->
    <div class="al-header">
      <div class="al-emoji">ğŸš¨</div>
      <div class="al-header-text">
        <div class="al-sos-label">Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦</div>
        <div class="al-countdown" id="al-countdown">ğŸ”Š ÙŠØ±Ù†...</div>
      </div>
      <div class="al-time" id="al-time"></div>
    </div>

    <!-- Body -->
    <div class="al-body">
      <div class="al-av-row">
        <div class="al-av" id="al-avatar"></div>
        <div class="al-info">
          <div class="al-name" id="al-name"></div>
          <div class="al-user" id="al-user"></div>
        </div>
      </div>
      <div class="al-msg" id="al-msg"></div>
      <div class="al-coords" id="al-coords"></div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± -->
    <div class="al-btns">
      <button class="al-loc-btn" id="al-loc-btn">ğŸ“ Ø¹Ø±Ø¶ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      <button class="al-respond" id="al-respond">
        <span>âœ…</span><span>Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
      </button>
      <button class="al-dismiss" id="al-dismiss">ØªØ¬Ø§Ù‡Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ (Ø³ÙŠØ±Ù† Ø¨Ø¹Ø¯ 15Ø«)</button>
    </div>
  </div>
</div>

<!-- TARGET SELECTION MODAL -->
<div class="tmod-overlay" id="target-modal">
  <div class="tmod-card">
    <div class="tmod-head">
      <div>
        <div class="tmod-title">ğŸ¯ Ø§Ø®ØªØ± Ù…Ø³ØªÙ„Ù…ÙŠ Ø§Ù„Ù†Ø¯Ø§Ø¡</div>
        <div class="tmod-subtitle">Ø§Ø¶ØºØ· Ù„ØªØ­Ø¯ÙŠØ¯ / Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯</div>
      </div>
      <button class="tmod-close" onclick="closeTargetModal()">âœ•</button>
    </div>
    <!-- ØªØ­Ø°ÙŠØ± Ù…Ù‡Ù… -->
    <div class="tmod-warning">
      âš ï¸ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ù…Ø²Ø§Ø­ Ø£Ùˆ Ù„Ø£Ø´ÙŠØ§Ø¡ ØºÙŠØ± Ø¶Ø±ÙˆØ±ÙŠØ© â€” Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ù…Ù†Ø¨Ù‘Ù‡ ÙˆÙ…ØµØ¯Ø§Ù‚ÙŠØªÙ‡
    </div>
    <div class="tmod-body">
      <div id="target-modal-list"></div>
    </div>
    <button class="tmod-confirm" onclick="closeTargetModal()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± âœ…</button>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
      <button class="modal-close" id="edit-close">âœ•</button>
    </div>
    <div class="edit-av-row">
      <div class="edit-av-disp" id="edit-avatar-disp"></div>
      <div>
        <button class="btn-change-av" id="edit-avatar-btn">ğŸ“· ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
        <input type="file" id="edit-avatar-file" accept="image/*" style="display:none">
        <div style="font-size:11px;color:var(--t2);margin-top:6px">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
      </div>
    </div>
    <div class="ig" style="margin-bottom:10px">
      <label class="il">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input class="inp" id="edit-name" dir="rtl" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
    </div>
    <div class="ig" style="margin-bottom:14px;position:relative">
      <label class="il">Ø§Ù„ÙŠÙˆØ²Ø±</label>
      <input class="inp" id="edit-username" style="direction:ltr;padding-left:60px" placeholder="username">
      <div class="uname-prev" id="edit-username-preview"></div>
    </div>
    <button class="btn-main" id="edit-save">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª âœ…</button>
  </div>
</div>

<!-- SPLASH -->
<div class="screen active" id="screen-splash">
  <div class="spl-logo">ğŸš¨</div>
  <div class="spl-title">RESCUE</div>
  <div class="spl-sub">Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙÙˆØ±ÙŠ</div>
  <div class="spl-dots">
    <div class="spl-dot"></div>
    <div class="spl-dot"></div>
    <div class="spl-dot"></div>
  </div>
</div>

<!-- REGISTER -->
<div class="screen" id="screen-register">
  <div class="auth-card">
    <div class="auth-logo">ğŸš¨ RESCUE</div>
    <div class="auth-sub">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>

    <div class="av-pick" id="reg-avatar-btn">
      <div class="av-pick-icon" id="reg-avatar-icon">ğŸ“·</div>
      <img id="reg-avatar-img" style="display:none" alt="">
    </div>
    <input type="file" id="reg-avatar-file" accept="image/*" style="display:none">

    <div class="ig">
      <label class="il">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input class="inp" id="reg-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯" dir="rtl">
    </div>
    <div class="ig" style="position:relative">
      <label class="il">Ø§Ù„ÙŠÙˆØ²Ø± (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
      <input class="inp" id="reg-username" placeholder="mhmd123" style="direction:ltr;padding-left:58px">
      <div class="uname-prev" id="username-preview"></div>
    </div>
    <div class="ig">
      <label class="il">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input class="inp" id="reg-pass" type="password" placeholder="6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„" dir="ltr">
    </div>
    <div class="ig">
      <label class="il">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input class="inp" id="reg-pass2" type="password" placeholder="Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="ltr">
    </div>

    <button class="btn-main" id="reg-submit">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸš€</button>
    <div class="auth-switch">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a onclick="initLogin()">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></div>
  </div>
</div>

<!-- LOGIN -->
<div class="screen" id="screen-login">
  <div class="auth-card">
    <div class="auth-logo">ğŸš¨ RESCUE</div>
    <div class="auth-sub">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>

    <div style="font-size:56px;margin:6px 0">ğŸ”</div>

    <div class="ig">
      <label class="il">Ø§Ù„ÙŠÙˆØ²Ø±</label>
      <input class="inp" id="login-username" placeholder="Ø£Ø¯Ø®Ù„ ÙŠÙˆØ²Ø±Ùƒ" style="direction:ltr">
    </div>
    <div class="ig">
      <label class="il">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input class="inp" id="login-pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="ltr">
    </div>

    <button class="btn-main" id="login-submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”‘</button>
    <div class="auth-switch">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a onclick="initRegister()">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Ù‹</a></div>
  </div>
</div>

<!-- MAIN -->
<div class="screen" id="screen-main">
  <!-- Topbar -->
  <div class="topbar">
    <div class="tb-user" onclick="switchTab('profile')">
      <div class="tb-av" id="topbar-avatar"></div>
      <div class="tb-info">
        <div class="tb-name" id="topbar-name"></div>
        <div class="tb-uname" id="topbar-username"></div>
      </div>
    </div>
    <div class="tb-logo">RESCUE</div>
    <div class="conn-ind" id="conn-status">â³</div>
  </div>

  <!-- Status -->
  <div class="status-bar">
    <div class="st-dot"></div>
    <span class="st-txt">Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·ÙˆØ§Ø±Ø¦</span>
  </div>

  <!-- Tab Contents -->
  <div class="tabs-content">

    <!-- HOME -->
    <div class="tab-content" id="content-home">
      <div class="target-sec">
        <div class="target-lbl">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡ Ø¥Ù„Ù‰:</div>
        <div class="target-selector" id="target-selector"></div>
      </div>
      <div class="sos-container">
        <div class="sos-rings">
          <div class="sos-ring"></div><div class="sos-ring"></div>
          <div class="sos-ring"></div><div class="sos-ring"></div>
        </div>
        <svg class="prg-svg" viewBox="0 0 228 228">
          <circle cx="114" cy="114" r="90" fill="none" stroke="transparent" stroke-width="5" id="prg-circle"/>
        </svg>
        <div class="sos-circle" id="sos-circle">
          <div class="sos-icon">ğŸ†˜</div>
          <div class="sos-lbl">Ø·ÙˆØ§Ø±Ø¦</div>
          <div class="sos-hint">Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹</div>
        </div>
      </div>
      <div class="sos-hint-bar">ğŸ’¡ Ø§Ø¶ØºØ· Ù…Ø·ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Â· Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</div>
    </div>

    <!-- FRIENDS -->
    <div class="tab-content" id="content-friends">
      <div style="padding:14px;display:flex;flex-direction:column;gap:10px;width:100%;">
        <div class="add-bar">
          <input class="inp" id="add-friend-input" placeholder="Ø£Ø¯Ø®Ù„ ÙŠÙˆØ²Ø± Ø§Ù„Ø´Ø®Øµ" style="direction:ltr"
            onkeydown="if(event.key==='Enter')handleAddFriend()">
          <button class="btn-add" onclick="handleAddFriend()">Ø¥Ø¶Ø§ÙØ© +</button>
        </div>
        <div class="friends-wrap">
          <div id="friends-list-container"></div>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="tab-content" id="content-history">
      <div style="padding:14px;width:100%;">
        <div id="history-container"><div class="loading-spin-sm"></div></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="tab-content" id="content-profile">
      <div style="padding:18px;width:100%;display:flex;flex-direction:column;align-items:center;">
        <div class="pf-card">
          <div class="pf-av" id="pf-avatar"></div>
          <div class="pf-name" id="pf-name"></div>
          <div class="pf-uname" id="pf-username"></div>
          <div class="pf-joined" id="pf-joined"></div>
          <div class="pf-stats">
            <div class="stat-c">
              <div class="stat-n" id="pf-friends-n">0</div>
              <div class="stat-l">Ø£ØµØ¯Ù‚Ø§Ø¡</div>
            </div>
            <div class="stat-c">
              <div class="stat-n" id="pf-alerts-n">0</div>
              <div class="stat-l">Ù†Ø¯Ø§Ø¡Ø§Øª</div>
            </div>
          </div>
          <button class="btn-edit" onclick="openEditProfile()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
          <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸšª</button>

        </div>
      </div>
    </div>

  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <button class="tab-btn" id="tab-home" onclick="switchTab('home')">
      <span class="ti">ğŸ </span><span class="tl">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </button>
    <button class="tab-btn" id="tab-friends" onclick="switchTab('friends')">
      <span class="ti">ğŸ‘¥</span><span class="tl">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</span>
      <span class="friends-badge" id="friends-badge" style="display:none"></span>
    </button>

    <!-- Ø²Ø± 911 ÙŠØ¹Ù„Ùˆ Ø§Ù„Ø´Ø±ÙŠØ· -->
    <div class="nav-911-wrap">
      <button class="nav-911-btn" onclick="call911()" aria-label="Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ 911">
        <span class="nav-911-num">911</span>
        <span class="nav-911-sub">Ø·ÙˆØ§Ø±Ø¦</span>
      </button>
      <span class="nav-911-label">Ø§ØªØµÙ„</span>
    </div>

    <button class="tab-btn" id="tab-history" onclick="switchTab('history')">
      <span class="ti">ğŸ“‹</span><span class="tl">Ø§Ù„Ø³Ø¬Ù„</span>
    </button>
    <button class="tab-btn" id="tab-profile" onclick="switchTab('profile')">
      <span class="ti">ğŸ‘¤</span><span class="tl">Ø§Ù„Ù…Ù„Ù</span>
    </button>
  </div>
</div>

</body>
</html>
